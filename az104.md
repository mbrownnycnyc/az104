- [AZ-104 Microsoft Azure Administrator Certification Prep](#az-104-microsoft-azure-administrator-certification-prep)
- [Azure Administration](#azure-administration)
  - [Understanding Azure Resource Manager](#understanding-azure-resource-manager)
    - [azure cloud fundamentals](#azure-cloud-fundamentals)
    - [exam tips](#exam-tips)
  - [using azure portal and cloud shell](#using-azure-portal-and-cloud-shell)
    - [describing azure portal](#describing-azure-portal)
    - [components of azure portal](#components-of-azure-portal)
    - [demo of using azure portal](#demo-of-using-azure-portal)
    - [summary](#summary)
  - [using Azure CLI and Powershell](#using-azure-cli-and-powershell)
    - [describing Azure CLI and powershell](#describing-azure-cli-and-powershell)
      - [azure CLI](#azure-cli)
      - [Powershell](#powershell)
    - [demo using cli and powershell](#demo-using-cli-and-powershell)
    - [summary](#summary-1)
  - [Using ARM templates](#using-arm-templates)
    - [what are ARM templates](#what-are-arm-templates)
    - [components of ARM templates](#components-of-arm-templates)
    - [demo using ARMs templates](#demo-using-arms-templates)
    - [summary](#summary-2)
- [governance and compliance](#governance-and-compliance)
  - [Managing Subscriptions](#managing-subscriptions)
    - [describing subscriptions](#describing-subscriptions)
    - [types of subscriptions](#types-of-subscriptions)
    - [subscription naming convention suggestions](#subscription-naming-convention-suggestions)
    - [summary](#summary-3)
  - [using management groups](#using-management-groups)
    - [defining mgmt groups](#defining-mgmt-groups)
    - [understanding hierarchy](#understanding-hierarchy)
    - [scoping influence](#scoping-influence)
    - [demo:](#demo)
    - [summary](#summary-4)
  - [Understanding Azure Policy](#understanding-azure-policy)
    - [define azure policy](#define-azure-policy)
    - [components of an Azure Policy](#components-of-an-azure-policy)
    - [policy example](#policy-example)
    - [demo: policy](#demo-policy)
    - [summary](#summary-5)
  - [tagging resources](#tagging-resources)
    - [describing resource tagging](#describing-resource-tagging)
    - [resource tag assignment hierarchy](#resource-tag-assignment-hierarchy)
    - [demo: tagging resources](#demo-tagging-resources)
    - [summary](#summary-6)
  - [LAB: Add, Remove and Update Tags for Resources in Azure](#lab-add-remove-and-update-tags-for-resources-in-azure)
  - [Logging and moving resources](#logging-and-moving-resources)
    - [describing Resource Locks](#describing-resource-locks)
    - [Types of Resource Locks](#types-of-resource-locks)
    - [Moving Resources](#moving-resources)
    - [Demo: locking and moving resources](#demo-locking-and-moving-resources)
    - [summary](#summary-7)
  - [managing azure costs](#managing-azure-costs)
    - [what impacts cost?](#what-impacts-cost)
    - [cost best practices and tools](#cost-best-practices-and-tools)
    - [demo: using Microsoft Cost Management](#demo-using-microsoft-cost-management)
    - [demo: using pricing calculator](#demo-using-pricing-calculator)
    - [demo: using TCO calc](#demo-using-tco-calc)
    - [summary](#summary-8)
  - [building a cloud governance strategy with azure tool](#building-a-cloud-governance-strategy-with-azure-tool)
    - [Define governance](#define-governance)
    - [planning a cloud staregy](#planning-a-cloud-staregy)
    - [governance services](#governance-services)
    - [summary](#summary-9)
    - [expand knowledge](#expand-knowledge)
- [Identity](#identity)
  - [Identity in Azure](#identity-in-azure)
  - [conceptualizing Entra ID](#conceptualizing-entra-id)
    - [IAM basics](#iam-basics)
    - [what is Entra ID](#what-is-entra-id)
    - [Entra ID Tenant Architecture](#entra-id-tenant-architecture)
      - [creation of Entra ID tenant:](#creation-of-entra-id-tenant)
    - [Entra ID Features](#entra-id-features)
    - [Entra ID versus Legacy AD](#entra-id-versus-legacy-ad)
    - [summary](#summary-10)
  - [managing tenants](#managing-tenants)
    - [planning our organization / designing tenants](#planning-our-organization--designing-tenants)
    - [demo: creating a tenant](#demo-creating-a-tenant)
      - [create a tenant](#create-a-tenant)
    - [summary](#summary-11)
  - [creating and managing users](#creating-and-managing-users)
    - [describing users](#describing-users)
    - [types of users](#types-of-users)
    - [demo: creating a user](#demo-creating-a-user)
    - [demo: managing user properties](#demo-managing-user-properties)
    - [demo: bulk adding users](#demo-bulk-adding-users)
    - [demo: inviting guests](#demo-inviting-guests)
    - [summary](#summary-12)
  - [LAB: Create and Manage Microsoft Entra ID Users in the Portal](#lab-create-and-manage-microsoft-entra-id-users-in-the-portal)
    - [Create Microsoft Entra ID User Accounts](#create-microsoft-entra-id-user-accounts)
    - [Modify a Microsoft Entra ID User Account](#modify-a-microsoft-entra-id-user-account)
    - [Revoke Access to a Microsoft Entra ID User Account](#revoke-access-to-a-microsoft-entra-id-user-account)
    - [Delete a Microsoft Entra ID User Account](#delete-a-microsoft-entra-id-user-account)
  - [LAB:](#lab)
    - [bulk create users](#bulk-create-users)
    - [bulk delete users](#bulk-delete-users)
    - [bulk add group member](#bulk-add-group-member)
  - [creating and managing groups](#creating-and-managing-groups)
    - [describing groups](#describing-groups)
    - [practical use of groups](#practical-use-of-groups)
    - [demo: creating a group](#demo-creating-a-group)
    - [demo: managing group membership](#demo-managing-group-membership)
    - [summary](#summary-13)
  - [LAB: Create a Group and Add a Member in Microsoft Entra ID](#lab-create-a-group-and-add-a-member-in-microsoft-entra-id)
    - [Create a New Microsoft Entra ID Group](#create-a-new-microsoft-entra-id-group)
    - [Add a Microsoft Entra ID User as a Member of the Group](#add-a-microsoft-entra-id-user-as-a-member-of-the-group)
    - [Create a New Microsoft Entra ID User](#create-a-new-microsoft-entra-id-user)
    - [Add a Microsoft Entra ID User as an Owner of the Group](#add-a-microsoft-entra-id-user-as-an-owner-of-the-group)
  - [Creating administrative units](#creating-administrative-units)
    - [describing administrative units](#describing-administrative-units)
    - [business use case for adminsitrative units](#business-use-case-for-adminsitrative-units)
    - [demo: creating administrative units](#demo-creating-administrative-units)
    - [summary](#summary-14)
  - [configure self-service password reset (SSPR)](#configure-self-service-password-reset-sspr)
    - [describing SSPR](#describing-sspr)
    - [SSPR Process](#sspr-process)
    - [auth methods when using SSPR](#auth-methods-when-using-sspr)
    - [SSPR considerations](#sspr-considerations)
    - [demo: setting up SSPR](#demo-setting-up-sspr)
    - [summary](#summary-15)
  - [Entra ID Device management](#entra-id-device-management)
    - [basics of device identity](#basics-of-device-identity)
    - [registration options](#registration-options)
    - [demo: managing devices](#demo-managing-devices)
    - [summary](#summary-16)
  - [identity summary](#identity-summary)
- [Role-based access control (RBAC)](#role-based-access-control-rbac)
  - [understanding roles in Azure](#understanding-roles-in-azure)
    - [Describing RBAC](#describing-rbac)
    - [Describing Azure Roles](#describing-azure-roles)
      - [role types](#role-types)
    - [describing Entra ID Roles](#describing-entra-id-roles)
      - [role types](#role-types-1)
    - [describing Azure roles vs. Entra ID Roles](#describing-azure-roles-vs-entra-id-roles)
    - [RBAC architecture](#rbac-architecture)
    - [summary](#summary-17)
  - [Assigning access to resources](#assigning-access-to-resources)
    - [explaining Azure RBAC](#explaining-azure-rbac)
    - [understanding role definitions](#understanding-role-definitions)
    - [additive property](#additive-property)
    - [demo: assigning access](#demo-assigning-access)
    - [summary](#summary-18)
  - [LAB: Using Service Principal Identity to List AD Roles](#lab-using-service-principal-identity-to-list-ad-roles)
  - [Creating custom roles](#creating-custom-roles)
    - [describing custom roles](#describing-custom-roles)
    - [creating custom role definitions](#creating-custom-role-definitions)
    - [demo: creating custom roles](#demo-creating-custom-roles)
    - [summary](#summary-19)
- [Azure Storage](#azure-storage)
  - [Understanding Storage Accounts](#understanding-storage-accounts)
    - [describing storage accounts](#describing-storage-accounts)
    - [components of storage accounts](#components-of-storage-accounts)
    - [understanding azure storage redudnancy](#understanding-azure-storage-redudnancy)
    - [demo: creating storage accounts](#demo-creating-storage-accounts)
    - [summary](#summary-20)
  - [conceptualizing azure blob storage](#conceptualizing-azure-blob-storage)
    - [describing azure blob storage](#describing-azure-blob-storage)
    - [components of blob architecture](#components-of-blob-architecture)
    - [types of blobs](#types-of-blobs)
    - [container access levels](#container-access-levels)
    - [demo: config blob storage](#demo-config-blob-storage)
    - [summary](#summary-21)
  - [configuring blob object replication](#configuring-blob-object-replication)
    - [describing object replication](#describing-object-replication)
    - [conceptualizing object replication](#conceptualizing-object-replication)
    - [benefits of object replication](#benefits-of-object-replication)
    - [demo: configuring object replication](#demo-configuring-object-replication)
    - [summary](#summary-22)
  - [configuring blob lifecycle management](#configuring-blob-lifecycle-management)
    - [describing lifecycle managmeent](#describing-lifecycle-managmeent)
    - [conceptualize lifecycle management](#conceptualize-lifecycle-management)
    - [demo: configure lifecycle management](#demo-configure-lifecycle-management)
    - [summary](#summary-23)
  - [LAB: Expire Data Based on Age in Azure Blob Storage](#lab-expire-data-based-on-age-in-azure-blob-storage)
  - [configuring azure files](#configuring-azure-files)
    - [describing azure files](#describing-azure-files)
    - [components of Azure Files](#components-of-azure-files)
    - [connectivity options](#connectivity-options)
    - [demo: working with Azure Files](#demo-working-with-azure-files)
    - [summary](#summary-24)
  - [configuring azure File Sync](#configuring-azure-file-sync)
    - [describing Azure File Sync](#describing-azure-file-sync)
    - [components of Azure File Sync](#components-of-azure-file-sync)
    - [File Sync Cloud Tiering](#file-sync-cloud-tiering)
    - [demo: Configure Azure File Sync](#demo-configure-azure-file-sync)
    - [summary](#summary-25)
  - [LAB: create and restore file share snapshots in Azure](#lab-create-and-restore-file-share-snapshots-in-azure)
  - [storage network access](#storage-network-access)
    - [storage access options](#storage-access-options)
    - [public endpoints](#public-endpoints)
    - [providing network access to service and resources in storage account](#providing-network-access-to-service-and-resources-in-storage-account)
    - [summary](#summary-26)
  - [securing storage accounts](#securing-storage-accounts)
    - [Azure Storage encryption](#azure-storage-encryption)
    - [Azure Storage authentication](#azure-storage-authentication)
    - [demo: securing storage accounts](#demo-securing-storage-accounts)
      - [access key administration](#access-key-administration)
      - [SAS can also be generated at the resource ("service") level](#sas-can-also-be-generated-at-the-resource-service-level)
      - [Storage Access Policies](#storage-access-policies)
      - [Azure Defender for storage](#azure-defender-for-storage)
    - [summary](#summary-27)
  - [LAB: limit access to azure storage account using SAS URI](#lab-limit-access-to-azure-storage-account-using-sas-uri)
  - [Using Azure Jobs](#using-azure-jobs)
    - [describing Azure Jobs](#describing-azure-jobs)
    - [import jobs](#import-jobs)
    - [export jobs](#export-jobs)
    - [demo: moving data](#demo-moving-data)
    - [summary](#summary-28)
  - [Storage utilizeies](#storage-utilizeies)
    - [describing utilities](#describing-utilities)
    - [demo: using storage utilities](#demo-using-storage-utilities)
      - [storage explorer](#storage-explorer)
      - [azcopy](#azcopy)
    - [summary (storage explorer vs. AzCopy)](#summary-storage-explorer-vs-azcopy)
- [sanity check](#sanity-check)
  - [how burned out do I really want to be?](#how-burned-out-do-i-really-want-to-be)
- [Virtual networks](#virtual-networks)
  - [Conceptualizing Virtual Networks](#conceptualizing-virtual-networks)
    - [describing networks](#describing-networks)
    - [traditional vs. virtual networks](#traditional-vs-virtual-networks)
    - [describing virtual networks](#describing-virtual-networks)
    - [components of virtual networks](#components-of-virtual-networks)
    - [summary](#summary-29)
  - [creating virtual networks](#creating-virtual-networks)
    - [designing a network](#designing-a-network)
    - [VNet features](#vnet-features)
    - [demo: creating a VNet](#demo-creating-a-vnet)
    - [summary](#summary-30)
  - [LAB: Create Multiple Subnets in Azure](#lab-create-multiple-subnets-in-azure)
  - [deploying network resources](#deploying-network-resources)
    - [IP addressing](#ip-addressing)
    - [types of IPs](#types-of-ips)
    - [public IP SKUs](#public-ip-skus)
    - [demo: NIC IP Configs](#demo-nic-ip-configs)
    - [summary](#summary-31)
  - [routing VNets](#routing-vnets)
    - [describing routing](#describing-routing)
    - [routing types](#routing-types)
    - [routing scenario](#routing-scenario)
    - [creating routes](#creating-routes)
    - [summary](#summary-32)
  - [Network Security Groups](#network-security-groups)
    - [defining NSGs](#defining-nsgs)
      - [functions](#functions)
      - [how are NSGs bound](#how-are-nsgs-bound)
      - [what it looks like](#what-it-looks-like)
    - [architecting NSGs](#architecting-nsgs)
    - [Implementing NSGs](#implementing-nsgs)
    - [summary](#summary-33)
  - [LAB: create an application security group for two web servers in Azure](#lab-create-an-application-security-group-for-two-web-servers-in-azure)
  - [Using Azure DNS](#using-azure-dns)
    - [describing Azure DNS](#describing-azure-dns)
    - [describing Record Sets](#describing-record-sets)
    - [describing Alias Records](#describing-alias-records)
    - [demo: creating a DNS zone](#demo-creating-a-dns-zone)
    - [summary](#summary-34)
  - [using azure firewall](#using-azure-firewall)
    - [describing azure firewall](#describing-azure-firewall)
    - [azure firewall features](#azure-firewall-features)
    - [implementation steps](#implementation-steps)
    - [demo: implement azure firewall](#demo-implement-azure-firewall)
      - [perform networking config for the firewall](#perform-networking-config-for-the-firewall)
      - [create rules in the firewall](#create-rules-in-the-firewall)
    - [summary](#summary-35)
  - [LAB: Attach a Firewall to a Virtual Network in Azure](#lab-attach-a-firewall-to-a-virtual-network-in-azure)
  - [using service endpoints](#using-service-endpoints)
    - [accessing PaaS services](#accessing-paas-services)
    - [describing service endpoints](#describing-service-endpoints)
    - [service endpoint considerations](#service-endpoint-considerations)
    - [demo: configuring a service endpoint](#demo-configuring-a-service-endpoint)
    - [summary](#summary-36)
  - [Using Private Endpoints](#using-private-endpoints)
    - [describing private endpoints](#describing-private-endpoints)
    - [demo: creating a private endpoint](#demo-creating-a-private-endpoint)
    - [summary](#summary-37)
- [intersite connectivity](#intersite-connectivity)
  - [configuring azure VNet peering](#configuring-azure-vnet-peering)
    - [describing VNET peering](#describing-vnet-peering)
    - [benefits](#benefits)
    - [demo: implementing](#demo-implementing)
    - [summary](#summary-38)
  - [Implementing VPNs](#implementing-vpns)
    - [VPN Gateway vs. VNet peering](#vpn-gateway-vs-vnet-peering)
    - [capabilities of VPN Gateways](#capabilities-of-vpn-gateways)
    - [routing types and VPN gateway SKUs](#routing-types-and-vpn-gateway-skus)
      - [SKUs](#skus)
    - [active-active vs. active-passive](#active-active-vs-active-passive)
      - [active-active](#active-active)
      - [active-standby](#active-standby)
  - [demo: implementing VPN Gateway](#demo-implementing-vpn-gateway)
    - [summary](#summary-39)
  - [Configure ExressRoute](#configure-exressroute)
    - [describing ExpressRoute](#describing-expressroute)
    - [Implementation Steps for an Expressroute](#implementation-steps-for-an-expressroute)
    - [demo: Configuring ExpressRoute](#demo-configuring-expressroute)
    - [summary](#summary-40)
  - [implementing Virtual WAN](#implementing-virtual-wan)
    - [describing Virtual WAN](#describing-virtual-wan)
    - [Hub-to-Hub connectivity](#hub-to-hub-connectivity)
    - [Virtual WAN SKUs](#virtual-wan-skus)
    - [demo: creating an Azure WAN](#demo-creating-an-azure-wan)
    - [summary](#summary-41)
  - [LAB: Create a Hub-spoke network topology in Azure](#lab-create-a-hub-spoke-network-topology-in-azure)
    - [lay out](#lay-out)
    - [procedure](#procedure)
- [Azure VMs](#azure-vms)
  - [creating and managing VMs](#creating-and-managing-vms)
    - [what is an VM](#what-is-an-vm)
    - [defining VMs](#defining-vms)
    - [VM workload families](#vm-workload-families)
    - [VM properties](#vm-properties)
    - [VM architecture](#vm-architecture)
    - [demo: create VM](#demo-create-vm)
    - [summary](#summary-42)
  - [Managing VM disks](#managing-vm-disks)
    - [what are VHDs](#what-are-vhds)
    - [purpose of VHds](#purpose-of-vhds)
    - [unmanaged vs managed disks](#unmanaged-vs-managed-disks)
    - [disk types](#disk-types)
    - [disk encryption](#disk-encryption)
    - [demo: create a VM and attach a disk and encrypt the disk](#demo-create-a-vm-and-attach-a-disk-and-encrypt-the-disk)
    - [summary](#summary-43)
  - [LAB: add existing data disk to a VM in Azure](#lab-add-existing-data-disk-to-a-vm-in-azure)
  - [configuring VM availability sets](#configuring-vm-availability-sets)
    - [Availability Sets](#availability-sets)
    - [demo: reviw availability sets](#demo-reviw-availability-sets)
  - [configuring VM scale sets](#configuring-vm-scale-sets)
    - [autoscaling operations](#autoscaling-operations)
    - [components:](#components)
    - [demo: create a scale set](#demo-create-a-scale-set)
    - [summary](#summary-44)
  - [LAB: Use PowerShell to Resize an Azure Virtual Machine in an Availability Set](#lab-use-powershell-to-resize-an-azure-virtual-machine-in-an-availability-set)
  - [Automating VM deployemtns](#automating-vm-deployemtns)
    - [why automate VM deployments](#why-automate-vm-deployments)
    - [how automate VM deployments](#how-automate-vm-deployments)
    - [Demo: deploy VM using ARM template](#demo-deploy-vm-using-arm-template)
    - [summary VM deployments](#summary-vm-deployments)
  - [LAB: Install NGINX on a Linux VM in Deployment with Cloud Init](#lab-install-nginx-on-a-linux-vm-in-deployment-with-cloud-init)
  - [LAB: Snapshot an Azure VM Disk using PowerShell](#lab-snapshot-an-azure-vm-disk-using-powershell)
  - [LAB: Using Custom Images for a Virtual Machine Scale Set in Azure](#lab-using-custom-images-for-a-virtual-machine-scale-set-in-azure)
  - [Managing Virtual Machine Updates](#managing-virtual-machine-updates)
    - [Describing update management](#describing-update-management)
    - [components of update management](#components-of-update-management)
      - [What happens:](#what-happens)
    - [demo: config update management](#demo-config-update-management)
    - [summary](#summary-45)
  - [Automating VM configs](#automating-vm-configs)
    - [describing config automation](#describing-config-automation)
    - [describing Powershell DSC](#describing-powershell-dsc)
      - [how it works](#how-it-works)
    - [Use case](#use-case)
    - [demo: configure DSC](#demo-configure-dsc)
    - [summary](#summary-46)
  - [Using Azure Bastion](#using-azure-bastion)
    - [what is azure bastion](#what-is-azure-bastion)
    - [azure bastion architecture](#azure-bastion-architecture)
    - [demo: implementing azure bastion](#demo-implementing-azure-bastion)
    - [summary](#summary-47)
  - [LAB: Access Windows VMs over SSL without Public IPs Using Azure Bastion](#lab-access-windows-vms-over-ssl-without-public-ips-using-azure-bastion)
- [network traffic mgmt](#network-traffic-mgmt)
  - [Introducing Azure Load Balancer](#introducing-azure-load-balancer)
    - [describing Azure LB](#describing-azure-lb)
    - [traditional vs. Azure LB](#traditional-vs-azure-lb)
    - [Components of an Azure LB](#components-of-an-azure-lb)
    - [demo: creating an LB](#demo-creating-an-lb)
    - [summary](#summary-48)
  - [LAB: Create a Standard Load Balancer with Azure CLI](#lab-create-a-standard-load-balancer-with-azure-cli)
  - [Using Application Gateway](#using-application-gateway)
    - [describing azure application gateway](#describing-azure-application-gateway)
    - [azure LB vs. app gateway](#azure-lb-vs-app-gateway)
    - [components of an app gateway](#components-of-an-app-gateway)
    - [demo: creating an app gateway](#demo-creating-an-app-gateway)
    - [summary](#summary-49)
- [web apps and containers](#web-apps-and-containers)
  - [creating an app service plan](#creating-an-app-service-plan)


# AZ-104 Microsoft Azure Administrator Certification Prep
* https://learn.acloud.guru/course/160303d7-6947-4fbc-9d19-fa304849f92e/dashboard
  * ~22 hours of course material, 16 hours of of labs allocated.
* may want to expand:
  * IAM: https://learn.acloud.guru/course/17e4d37f-5a2a-4840-81a7-c2884425c576/dashboard
  * Storage: https://learn.acloud.guru/course/17ee4dc4-6f8e-4411-b0e9-26bdd4b8936c/dashboard
* https://learn.microsoft.com/en-us/credentials/applied-skills/implement-security-through-pipeline-using-devops/

# Azure Administration
* https://learn.acloud.guru/course/160303d7-6947-4fbc-9d19-fa304849f92e/learn/39e08dc6-afb5-48e0-82a1-91b12cd0e132/616d2de3-8a6c-47f1-9727-0a3de716d988/watch
  
## Understanding Azure Resource Manager

### azure cloud fundamentals
* what are clouds?
  * resources: entity managed by Azure
    * VMs, storage accounts, and VNets
    * logically grouped into resource groups
  * resource groups: logical container for grouping resources, based on lifecycle and security
    * logically grouped into subscriptions
  * subscriptions: logical container that groups together resources groups
    * billing unit for the azure clud
    * controlled by ARM
* Azure Resource Manager: orchestration layer for managing the Azure cloud
  * REST API endpoints (powershell, azcli, web UI, etc)
  * ARM interfaces with the resource providers
    * each resource has a `resource provider` completes the request to CRUD the resource
* Entra ID: IAM resource, this restricts access to ARM to a Tenant (unless trust relationship exists).

### exam tips
* resources are azure managed entities, like VMs, storage accounts, VNets
* understand resource hierarchy

## using azure portal and cloud shell

### describing azure portal
* what is azure portal: web UI to manage resources in Azure
* Cloud Shell is within web UI

### components of azure portal
* can open support ticket via ? menu on left top pane

### demo of using azure portal
* view demo
* note that the resource provider is visible under Type:
  ![](2024-08-05-10-17-13.png)

### summary
* login via Entra ID identity
* CRUD azure resoruces 
* manage azure via cloud shell
* manage billing
* log support tickets

## using Azure CLI and Powershell

### describing Azure CLI and powershell

![](2024-08-05-10-23-25.png)

#### azure CLI
* command line utility for managing azure resources
* perform CRUD operations without logging in to Azure portal
* create scripts to automate tasks

#### Powershell
* set of cmdlets for managing azure resources
* perform CRUD operations without logging in to Azure portal
* create scripts to automate tasks

### demo using cli and powershell
* login to azure portal
* use cloud shell

  ![](2024-08-05-10-24-15.png)
  * you will need to create storage account, etc
  * start a powershell instance
* get resourcegroup
  ![](2024-08-05-10-24-56.png)
    * returns various defaults attribs about resourcegroup list in json
  ![](2024-08-05-10-25-30.png)
* create azure resources
  ![](2024-08-05-10-27-04.png)
  * `--generate-ssh-keys` stores keys locally (either in azure cloudshell or on your local machine)
    ![](2024-08-05-10-27-54.png)
* verify VM creation
  ![](2024-08-05-10-28-43.png)
* you can use vscode in the cloudshell by invoking `code`

### summary
* azcli and powershell can:
  * manage azure resources locally (including in azure cloudshell)
  * create scripts for automation
  * no need to log in to the Azure portal

## Using ARM templates

### what are ARM templates
* ARM templates are "azure resource templates"
* IaC
* Deploy environments quickly
* repeatable deployments
* scope of application of an ARM template: can be a resource group, can be a subscription
  
### components of ARM templates

![](2024-08-05-10-33-40.png)

* is JSON
* `parameters` (passed at run time) and `variables` (hard coded) components are used to pass info via template.
* `resources` component is used to define resources in the template
* `outputs` component is used to return output from the execution of the template.

### demo using ARMs templates
* get template from github
* deploy to azure cloud
  * go to "Deploy Custom Deploy" in ARM
  * Resource Visualizer
    ![](2024-08-05-10-35-03.png)
  * in the custom template, you can make some adjustments
    ![](2024-08-05-10-36-18.png)
  * create
    ![](2024-08-05-10-37-15.png)
* verify the creation of resources
  * can active review resource group in ARM to verify creation
* note that you can address items via variables:
  ![](2024-08-05-13-12-21.png)

### summary
* ARM templates are Declarative JSON (IaC)
* quickly deploy repeatable and modular envs
  * you can call other ARM templates from ARM templates

# governance and compliance

## Managing Subscriptions

### describing subscriptions
* billing unit that aggregates all costs of underlyind `resources`
* contain `resource groups` and their associated `resources`
* scoping level for governance and security
  * AD tenant
    * roles can be applied to subscriptions, etc.

### types of subscriptions
![](2024-08-05-10-43-12.png)

* login to ARM
* type subscriptions
* go to add another subscriotion
* review offers

### subscription naming convention suggestions
* prod/dev/staging
  * subscriptions are named based on whether they are prod, dev, or staging envs.
* departments/teams
  * subscriptions are named based ont he dept or team the sub is split up so that billing can then be easily associated with a given business unit.
* region
  * subs are named based on the region of the business that uses the subscription.

### summary
* subscriptions:
  * billing unit that aggregates all costs of underlying resources
  * contain resource groups and associated resources
* scoping level for governance and security
* can be associated with a single organization Entra ID tenant at a time

## using management groups

### defining mgmt groups
* logical container to organize and manage subscriptions and other mgmt groups
  * organization hiearchy
  * provides another scope for enforcing governance and compliance

### understanding hierarchy

![](2024-08-05-11-11-15.png)

* parent-child relatonships
  * root mgmt group is the top-level 
  * mgmt groups and subs can have a single parent
  * supports six levels of hierarchy
* compliance support (to target mgmt groups and subscriptions, via hierarchy):
  * Azure Policies
  * Azure RBAC

### scoping influence
* RBAC (as users icon), scope (as target icon), subscription (as key icon)

![](2024-08-05-11-11-52.png)

### demo:
* go to management groups/overview
* can create resources, etc.
* can add role assignments (ie: billing reader, etc)

### summary
* mgmt groups provide hierarchy of management
* root management group access is not given by default
* root management group can't be moved or seletec
* Azure RBAC is supported for mgmt groups
* Global Administrators must be elevated to USer Access Administrator of root group.
  * temporarily assign this role only

## Understanding Azure Policy

### define azure policy
* enforce compliance and enable auditing (detective controls, preventative controls, and corrective controls (this is a unique situation) )
* organizations need to implement enterprise-level governance and compliance capabilities
* uses
  * prohibit resources
    * control costs
    * restrict service access
  * restrict to allowed locations
    * geographical compliance

### components of an Azure Policy
* policy definitions: defines that evaluation criteria for compliance, and defines the actions that take place.  Either audit or deny should be something outside of compliance.
* policy assignment: the scope at which we will assign our policy.  The scope could be a mgmt group, subscription, resource group or resource.
* `initiative` definition: a collection of policies that are tailored to achrieve a singular high-level goal (ie: ensuring that VMs meet standards).

### policy example
* goal: "require tags"
* generate a policy definition
  * evaluate if a VM is being created with our tag "Project: az104" if the VM is missing the tag, then deny creation of resource.
* policy assignment
  * assign the policy at the scope of the resource group where the VMs will be created.


### demo: policy
* go to ARM/Policy
* authoring/Definitions (there are many built in)
  * each definition has some parameters:
    ![](2024-08-05-11-34-40.png)
  * Policy Enforcement: when enforcement mode is disabled, the policy effect isn't enforce (ie: deny policy won't deny resources).  Compliance assessment results are still avialable (see https://aka.ms/enforcementMode )
* Assignments
  * takes about 30 minutes to apply and scan
  * You can then go to policy/compliance to review
    ![](2024-08-05-11-38-30.png)
* Exemptions
  * they occur during assignments

### summary
* Azure Policy applies governance
  * create manage and assign policies.
  * Can be used to enforce (you can deny creation of resources outside of compliance) or audit compliance on resources.
* Policy components:
  * policy definition
  * policy assignment
* Many policies can be combined:
  * Initiative definition: can scope many definitions

## tagging resources

### describing resource tagging
* what are tags? name:value pair that can be attached to objects in Azure Tenant.
* name can be 512 chars, value can be 256 chars (storage accounts name can only be 128 chars)
  * can't reuse the same name in the same scope
* examples:
  * Dept:Marketing
  * Env:Prod
* usage:
  * cost analysis
  * Azure Policy

### resource tag assignment hierarchy
* `tags` are NOT inherited from assignment scope/by hierarchy
  * Azure Policies can enforce inheritance
* a resource can have a maximum of 50 tags

### demo: tagging resources

* determine tag
* tag a resource group
* log in to Azure portal
  * ARM/Resource Groups
  * Access resource gorup, tags on left pane
    * ms-resource-usage: production
    * this tag will NOT fall down to resources in the resource group

### summary
* tags (name/value pairs) can be used to:
  * manage resources
    * shutting down all VMs via a tag, or enforce policy, or billing
* tags are not inherited, but can be via Azure Policy

## LAB: Add, Remove and Update Tags for Resources in Azure

* Add Tags to the Resource Group
  * add tags via cloud shell:
    ![](2024-08-05-12-03-29.png)
  * verify:
    ![](2024-08-05-12-00-17.png)
* list VMs and filter using JMESpath
  ![](2024-08-05-12-04-49.png)
* Remove Tags for VM
  ![](2024-08-05-12-06-11.png)
* Add tag "MarkForDeletion"
  ![](2024-08-05-12-07-42.png)
* Change Tags for the Virtual Network
  * list:
    ![](2024-08-05-12-08-28.png)
  * set:
    ![](2024-08-05-12-09-57.png)

## Logging and moving resources

### describing Resource Locks
* what are locks:
  * locks allow you to overrise perms to resources
  * can lock subscriptions, resource grops or resources
  * locks apply to all users and roles

### Types of Resource Locks
* `ReadOnly`: allows authed users to resource, but can not delete or update resource (ie: you can't power off a VM... you can't affect state at all!)
* `CanNotDelete`: allows authed users to read and modify a resource, but can't delete. (ie: you can't delete a VM)
* will inherited from the parent scope! (opposite of tags)

### Moving Resources
* taking a resource contained in a place (like a resource groups), can move to other resource groups within subscription, or to RG in another subscription.
* moving is write and delete operation
* some resources don't support moving

### Demo: locking and moving resources
* login to ARM web UI
* Create VM resource
  * check out [azure-quickstart-templates](https://github.com/Azure/azure-quickstart-templates)
    * ie: https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.compute/1-vm-loadbalancer-2-nics/azuredeploy.json
* Add a delete lock
  * review locks: in RH, left side pane> settings> locks> add a lock
  * note that the scope
    ![](2024-08-05-13-13-27.png)
* move resources
  ![](2024-08-05-13-15-20.png)

### summary
* resource lock types:
  * `ReadOnly`: allows authed users to resource, but can not delete or update resource (ie: you can't power off a VM... you can't affect state at all!)
  * `CanNotDelete`: allows authed users to read and modify a resource, but can't delete. (ie: you can't delete a VM)
* there is inheritance for locks

## managing azure costs

### what impacts cost?
* subscription type: free, pay-as-you-go, enterprise agreements, cloud solution provider
* resource type: various types have different costs (storage account blob storage vs. table storage)
* usage meters: CPU time, ingress/egress network traffic, disk size...
* resource usage: the costs of actually using a resource (ie: VM run time)
* region/location: the costs for various services vary across geographic regions

### cost best practices and tools
* Best practices
  * select the appropriate resoruce for the use case (ie: PaaS, SaaS, IaaS)
  * understand resource needs (right sizing)
  * deallocate resources when not needed
  * use cloud capabilities where possible (ie: scalability, elasticity)
  * Plan costs prior to purchase
* cost tools:
  * pricing calc: how much will resources cost us to run at given spec
  * TCO calc: analyze on-prem workloads and obtain costs
  * Microsoft Cost Management:
    * analyze costs
    * create budget

### demo: using Microsoft Cost Management
* must have Billing Manager role to scope
* main dashboard:
  ![](2024-08-05-13-24-58.png)

### demo: using pricing calculator
* is public facing
* estimate workload costs
* modify workload details
  ![](2024-08-05-13-27-32.png)

### demo: using TCO calc
* how much will on prem services costs to run in Azure cloud

![](2024-08-05-13-28-54.png)

### summary
* pricing calc: how much will resources cost us to run at given spec
* TCO calc: analyze on-prem workloads and obtain costs
* Microsoft Cost Management: analyze costs, create budget

## building a cloud governance strategy with azure tool

### Define governance
* define rules, policies, compliance standards
* define control over resources, enforce rules, policies and standards

### planning a cloud staregy
* define: define the cloud governance needs of the organization 
  * driven by things like regulatory
* Plan: plan which tools will be used to implement governance
* Ready: understand how those tools will be used to implement governance
* adopt: implement governance for the org using a cloud strategy

### governance services
* management groups and subscriptions: organize subscriptions into heirachical structures
* Azure RBAC (roles): provide access to resoruces at varying scopes.
* Azure Policies: implement policies to enforce standards
* Locks and tagging: lock resources to preevent deletion, and tag resources to categorize.

### summary

![](2024-08-05-13-41-10.png)

* management groups/subscription/resource group hierarchy
* policies are used to control
* (RBAC) role assignment to resource groups
* locks

### expand knowledge
* Azure blueprints: allows for an entire Azure build (including subscriptions, etc) as per a description focused around environment object and policy creation (including ARM templates) and will help with governance.

# Identity

## Identity in Azure
* Azure AD / Entra ID
  * IAM basics
  * define Entra ID
  * Entra ID tenant
  * Entra ID architecture
  * compare Entra ID with legacy AG
  * Create and switch between tenants
* Entra ID Users
  * define users, types of users, methods of creating users, architecture
  * create and delete users
  * perform bulk user updates
  * invite guest accounts
* Entra ID groups
  * define groups, group and membership types, RBAC
  * create dynamic groups
  * assign access to resources
* Entra ID join:
  * define Entra ID Join, device settings and conditional access
  * join Windows 10 to Entra ID
* Administrative units:
  * Define MFA and self-service password reset (SSPR)
  * enable MFA
  * enable SSPR

## conceptualizing Entra ID

### IAM basics
* principal: unauthed entity that will seek to auth as an identity
* identity: identity profile that is authed against using creds
* authorizations: actions that are permitted/prohibited for an identity to perform

### what is Entra ID
* is an... IAM management solution: a global cloud-based identity service for Azure that provides an identity resposiroty
* allows for... creation identity resources: create users and groups 
* is a... management plane for identity-based security: enable MFA, control resource access, and provide policy-based controls
* organization == tenant == directory

### Entra ID Tenant Architecture
* Entra ID is a global service across the Azure cloud
* our specific tenant instance is local to a geography (ie: United States, EU)

#### creation of Entra ID tenant:
* a domain is created when requested
* the tenant provides RBAC to perform actions on subscriptions

### Entra ID Features
* IAM platform: Entra ID is the RBAC solution that grants access (via RBAC) to Azure tenant and it's resources and management functions.
* Identity security: additional security with MFA (conditional access policies) and Privileged identity management (PIM)
* Collaboration and Developent: Entra ID B2B and B2C (covering later)
* Monitoring: audit logs, security monitoring, identity protection and risk management (derive risk levels of identities)
* identity integration features: hybrid identity and SSO using Entra ID Connect and Azure AD Domain Services.
* Enterprise access: additional security for apps and devices on prem and in the cloud

### Entra ID versus Legacy AD
* AD:
  * OUs
  * GPOs
  * Kerberos, LDAP,NTLM
  * Hiearchical
  * on-prem
* Entra ID:
  * Administrative units
  * SAML, WS-federation, OAuth
  * flat directory structure
  * cloud-based solution
  * Global
* bridge the two together using Entra ID Connect

### summary
* Entra ID
  * Tenant is the organization instance
* purposes:
  * IAM: global cloud-baed identity service for Azure that provides an identity repo.
  * Create identity resources: create users and groups.
  * Manage identity security: enable conditional access policies, control resource access and provide policy-based controls across all Azure resource instances and management functions.

## managing tenants

### planning our organization / designing tenants
* planning out the design of oure tenant will supprot easy adoption
  * Build security Foundations: set up best practices (ie: SSPR, MFA, backup global admin and prived users) for specific tasks
  * populate identity resources: add users, create groups, add devices, and set up hybrid identity.
  * manage apps: identity apps to be used from the app gallery and register apps from on-prem.
  * Monitor and automate: monitor admins, perform access reviews and automate user lifecycles.

### demo: creating a tenant
#### create a tenant
* login to ARM and access Entra ID
  ![](2024-08-05-14-26-44.png)
* review config of tenant:
  ![](2024-08-05-14-28-20.png)
* Create
  ![](2024-08-05-14-28-45.png)
  * B2C provides external users access to applications (as application/resource authentication can integate directly into B2C directories)
  ![](2024-08-05-14-29-35.png)

### summary
* Entra ID tenant is within your region
* inside the tenant all identity resources exist

## creating and managing users

### describing users
* Entra ID contain users and group objects (ie: administrators, members, guests)
* each identity object has:
  ![](2024-08-05-14-37-43.png)
  * permissions
  * can be JSON objects
  * each user can have role assignments
  * each user can have object ownership (ie: a user can own a group)

### types of users
* administrators: users with adminsitrator role assigned
* members: regular users that are native to Entra ID
* guests: external users that are invited to the Entra ID tenant

### demo: creating a user

* methods of creating users
  * Azure portal: Entra ID service> users> new user
    ![](2024-08-05-14-40-45.png)
  * Azure CLI: `az ad user create`
  * Powershell: `new-azureaduser`
* create a user inside of Entra ID tenant
  * can set a usage location
  * can block user signin

### demo: managing user properties
* update user profiles to show that the user is part of HR department
  * find user in Entra ID
  * edit properties

### demo: bulk adding users
* using a CSV to bulk add users
  * go to Entra ID
  * bulk operations, then download a CSV
  * the CSV has examples, and make sure you include trailing commas
  * upload files

### demo: inviting guests
* go to entra ID
* click New User> invite new user
* select template> invite user
* requires only email.
* Entra ID will send an email
* user type will be Guest

### summary
* Entra ID tenant users and groups exist
* types of users: admins, member, guests
* Role assignment: determines perms and access
* Object ownership: apps, devices, groups and resources that are owned

## LAB: Create and Manage Microsoft Entra ID Users in the Portal

### Create Microsoft Entra ID User Accounts
* ![](2024-08-05-14-49-36.png)
* ![](2024-08-05-14-50-32.png)
* ![](2024-08-05-14-51-29.png)

### Modify a Microsoft Entra ID User Account
* ![](2024-08-05-14-51-58.png)
* ![](2024-08-05-14-52-33.png)
* reset password
  * ![](2024-08-05-14-53-05.png)


### Revoke Access to a Microsoft Entra ID User Account
* ![](2024-08-05-14-53-32.png)

### Delete a Microsoft Entra ID User Account
* ![](2024-08-05-14-54-07.png)
* ![](2024-08-05-14-55-01.png)
* deleted users remain to be able to be restored for 30 days

## LAB:

### bulk create users
* ![](2024-08-05-15-18-50.png)
* ![](2024-08-05-15-19-49.png)
* OBtain domain name by reviewing the Entra ID tenant info page and update the users
* ![](2024-08-05-15-23-17.png)
* ![](2024-08-05-15-24-30.png)

### bulk delete users
* ![](2024-08-05-15-24-56.png)
* ![](2024-08-05-15-26-13.png)
* blah blah

### bulk add group member
* create a new group of security group type
* ![](2024-08-05-15-29-06.png)

## creating and managing groups

### describing groups
* Entra ID tenant has user and groups objects
* leverage groups to provide groups of users to apply roles
* owner and members: an owner of the group or a member of the group
* type of group: a security group or a M365 group
* membership type: assigned, dynamic user, or dynamic device

### practical use of groups
* RBAC:
  * rule based/dynamic assignment:  department value == "HR", then in "HR Group"
  * dynamic group assignment requires above E1 licensing

### demo: creating a group
* access ARM
* create a group

### demo: managing group membership
* go to groups
* ![](2024-08-05-15-40-01.png)
  * Dynamic User (group of users)
* ![](2024-08-05-15-40-26.png)
* validate the rule
  * set scope of all users

### summary
* group types:
  * security groups: are used to manage access to shared resources for a group of users
  * M365 gorups: used to give members access to shared mailbox, calendar, files, etc
* Membership types:
  * assigned: static group membership
  * dynamic user: logic based given user properties
  * dynamic device: created that automate group membership via device attributes.

## LAB: Create a Group and Add a Member in Microsoft Entra ID
* https://learn.acloud.guru/course/160303d7-6947-4fbc-9d19-fa304849f92e/learn/175d605b-0154-4bb4-b924-8f8358787113/acdc78a6-56a6-4c1c-ad3d-717a5dc2bfa0/lab/acdc78a6-56a6-4c1c-ad3d-717a5dc2bfa0

### Create a New Microsoft Entra ID Group
* yarp.
  
### Add a Microsoft Entra ID User as a Member of the Group
* yarp.

### Create a New Microsoft Entra ID User
* yarp

### Add a Microsoft Entra ID User as an Owner of the Group
* yarp

## Creating administrative units

### describing administrative units
* create logical containers inside of Entra ID that contain resources (such as groups) that can have RBAC roles attached to them.
  * For example, you might have a group called HRGroup with users in the US and users in the EU.  You want to restrict the HRGroup that's in the US to only be admined by helpdeskadmins in the US, and vice-versa.  You can create an administrative unit for the HRGroup in the US based on specific field values.  This avoids assigning roles to Tenants.

### business use case for adminsitrative units
* similar to the above example

### demo: creating administrative units
* plan the organization: evaulate its needs to determine the value that administrative units can provide for managing identities, like groups and users.
* create an Administrative Unit: to logically divide the organization and allow for scoping.

* access Entra ID
* access administrative units, membership type is "assigned" (other types is `dynamic user` and `dynamic device`).
* you can assign a role, and then select a user.

### summary
* purpose of administrative units: an Entra ID resource for providing a container for Entra ID objects.
* allow you to control the scope of your administrative users.
* Use case: administrative units based on geographical locations, business departments, or subsidiary organizations of a parent organization.

## configure self-service password reset (SSPR)

### describing SSPR
* old school password reset method
  * single point of failure: helpdesk admin resets user's passwords
    * creates admin overhead and creates less productive users.
* enables users to change or reset, increases their productivity, and decreases admin overhead

### SSPR Process
* check browser localization settings
* verification of identity
* authenciation
* password reset
* notification for user and administrators

### auth methods when using SSPR
* mobile app: authentication via app notification.  An example is the MSFT authenticator app.
* mobile app code: autentication via TOTP.
* Email: codes sent via email.
* Mobile phone: SMS or phone call
* Office phone: calls and prompts user to press #.
* security questions: auth via answerring a set of security questions (not recommended) 

### SSPR considerations
* enable and manage SSPR via Entra ID groups
* required methods: one or more available auth methods is required
* SSPR for admins: security questions not available for admins.  By default, admins must register for MFA methods.
* Required licenses: Entra ID P1 or P2, Microsoft apps for business or M365 licensing is required for SSPR

### demo: setting up SSPR
* enable SSPR
  * go to Entra ID
  * password reset
  * manage/properies
    * "selected" you can select a group
    * "all" is all users
  * authentication methods:
    ![](2024-08-05-20-48-41.png)
    * 1 or 2 methods
    * select methods available
  * Registration: require users to register when signing in?
  * notifications:
    * notify users when their passwords are reset
    * notify all admins when other admins reset their passwords
  * on-premises integration
* test SSPR
  * can create a new user
  * and then login, setting up

### summary
* SSPR:
  * unauthed users use SSPR
  * decreases admin overhead
  * securre password reset for users and admins

## Entra ID Device management

### basics of device identity
* BYOD can be registered
  * to control access to resources, data, assets

### registration options
* Entra ID registered
  * least restrictive option, allowing BYOD with a personal MSFT or local account.
  * Supports Windows 10/11, iOS, iPadOS, Android, and macOS
* Entra ID joined
  * device is owned by the org and accesses Entra ID through a work account.  These identities exist only in the cloud.
  * supports Windows 11/11, SErver 2019
* Hybrid Entra ID Joined
  * Similar to Entra ID Joined
  * however, these device identities exist both on-prem and in the cloud.
  * supports: Windows 7, 8.1, 10, 11, Server 2008 or later

### demo: managing devices
* login to ARM
* access entra ID
  ![](2024-08-05-20-58-52.png)
* go to All Deviecs and review
* go to Device SEttings (who and how)
  * options for user scope
    ![](2024-08-05-21-00-25.png)
    * "users may registr their devices with Entra ID" == Entra ID registered (BYOD)
  * Administative users can be added to "Entra ID joined" devices only as local users

* join device as Entra ID registered
  ![](2024-08-05-21-05-10.png)
  ![](2024-08-05-21-08-28.png)

* Note that you must be a local admin on the machine to join the machine to Entra ID (similarly to legacy AD):
  ![](2024-08-05-21-07-01.png)
  ![](2024-08-05-21-07-56.png)

### summary
* device identity: gives devices identities so that the devices can access resources in Entra ID
  * simplified procedure for adding and managing devices
  * improve user experienc on devices
  * SSO for any registrered or joined

## identity summary
* Azure AD / Entra ID
  * IAM basics
  * define Entra ID
  * Entra ID tenant
  * Entra ID architecture
  * compare Entra ID with legacy AG
  * Create and switch between tenants
* Entra ID Users
  * define users, types of users, methods of creating users, architecture
  * create and delete users
  * perform bulk user updates
  * invite guest accounts
* Entra ID groups
  * define groups, group and membership types, RBAC
  * create dynamic groups
  * assign access to resources
* Administrative units:
  * Define MFA and self-service password reset (SSPR)
  * enable MFA
  * enable SSPR
* Entra ID join:
  * define Entra ID Join, device settings and conditional access
  * join Windows 10 to Entra ID

# Role-based access control (RBAC)

## understanding roles in Azure

### Describing RBAC
* who?
  * security principals (users, groups)
* what?
  * roles
    * security principals are assigned roles
* where
  * scope
    * roles provided effective permissions to a scope

### Describing Azure Roles
* ability to provide security pricipals to a role assignment via a role definition, and provide a scope
* the scope is as per the Azure tenant hierarchy and applied to `resources`

#### role types
* owner: full access to resources and can grant access
* reader: can only view resources
* contributor: create and manage resources
* user access administrator: can grant access to resources

### describing Entra ID Roles
* Entra ID roles
  * users
  * groups
  * admins
* provides the ability to manage Entra ID identity objects (users, devices) inside of Entra ID tenant

#### role types
* global admin role: can manage Entra ID identity resources (not just identity objects, but all resources)
* billing administrator: can perform billing tasks
* user administrator: can manage users and groups
* helpdesk administrator: can reset passwords for users

### describing Azure roles vs. Entra ID Roles
* Azure (RBAC) roles:
  * managing access to Azure `resources`
  * scope can be at multiple levels
  * supports custom roles
  * has a few role types
* Entra ID roles
  * manage access to Entra ID resources within Entra ID tenant
  * scope is at tenant level
  * supports custom roles
  * has a few role types

### RBAC architecture
* Entra ID is the IdP, which has a directory.  Entra ID roles are those that allow a user to interface with Entra ID IdP itself.
* Azure Roles (RBAC) provides access to the Entra ID users to access to Azure `resources`.
* there is a special role for global admin/user access admin which is at the root of everything

### summary
* Azure (RBAC) roles:
  * managing access to Azure `resources`
  * scope can be at multiple levels
  * supports custom roles
  * has a few role types
  * scope at management groups, subscriptions, resource groups, and resources
* Entra ID roles
  * manage access to Entra ID resources within Entra ID tenant
  * scope is at tenant level
  * supports custom roles
  * has a few role types
  * Administrative Units can help with scoping

## Assigning access to resources

### explaining Azure RBAC
* Azure RBAC is an authorization system for Azure resources
  * identities have an implicit deny to Azure resources, there must be an explicit allow, then an explicit deny may use to constain the allow rules.
* who?
  * security principals (users, groups)
* what?
  * roles
    * security principals are assigned roles
* where
  * scope
    * roles provided effective permissions to a scope

### understanding role definitions
* `contributor` role
  ![](2024-08-06-10-02-28.png)
  * `Action`: which actions can be performed, explicit allow, on control plane
  * `NotActions`: explicit deny, on control plane
  * `DataAction`/`NotDataAction`: explicit allow/deny, but on data "plane" (aka storage accounts)
  * `AssignableScopes`: the scope of the role
* combining == "collective permissions"

### additive property
* more than one role can be combined
* overlapping roles for a single identity, they are cumulative/additive == effective permissions.

### demo: assigning access
* select a user
* select the role that will be applied to user
* select the scope for the role

* access ARM
* access the Azure hierarchy member (resource group for example) and IAM
  ![](2024-08-06-10-06-28.png)
* add and select the role, and add members to the role assignment
  ![](2024-08-06-10-07-04.png)
* 

### summary
* Azure RBAC == authorization system to provide access to Azure resources
* implicit deny -> explicit allow -> explicit deny
* roles are cumulative/additive, Azure heirarchy inheritance applies

## LAB: Using Service Principal Identity to List AD Roles
* Log in to Azure using the Service Principal via azcli on a Windows machine
* List the Role Definitions and Role Assignments

* authenticate with `ssh` from your local machine to the VM hosted in Azure
* authenticate using a service principal to the Entra ID tenant
  ![](2024-08-06-10-15-50.png)
* list role definitions
  ![](2024-08-06-10-16-41.png)
* list role assignments
  ![](2024-08-06-10-17-26.png)

## Creating custom roles

### describing custom roles
* a custom role is one you make that aren't built-in, because no built-in role meets requirements
* `User Access Administrator` or `Owner` role for an account

### creating custom role definitions
* base line == built-in role "virtual machine contributor"
  ![](2024-08-06-10-19-08.png)
* custom role, go to Access Control/IAM on a scope resource, then view the role, then click JSON, copy and paste and modify
  ![](2024-08-06-10-20-20.png)

### demo: creating custom roles
* login to ARM
* create a role JSON
  ![](2024-08-06-10-21-54.png)
* access a resource group, then access control/IAM
* go to Roles and click Add or use azcli
  ![](2024-08-06-10-24-51.png)
* click view role, within role, click assignment
  ![](2024-08-06-10-25-49.png)
* can "check access"
  ![](2024-08-06-10-26-20.png)

### summary
* custom roles
  * provide identities with access to azure resources or Entra ID objects
  * roles are collection of permissions
  * scoping hiearchy for role assignments
  * custom role definitions are JSON and should be based on built-in roles
  * create a custom role when there are no built-in role that meets your requirements
  * to create a custom role, you must have `User Access Administrator` or `Owner` role for the account

# Azure Storage

## Understanding Storage Accounts

### describing storage accounts
* storage account is a top level resource for storage 
  * contains different sub services
  * Azure Queue: message based storage for microservices
  * Azure Table: noSQL semi-structured data storage service
  * Azure Files: cloub based file sharing service
  * Azure blob: object-oriented storage solution

### components of storage accounts
* service tier: determines features and costs
* performance tier: determines perf levels
* Replication: determines infra redundancy
* access tier: determines access levels (retrieval) and data costs (storage)

### understanding azure storage redudnancy
* Azure global infra is made up of geographies, which are split into regions, within each region, there are multiple availability zones (interconnected via low latency connections)
* each storage redundancy solution has three copies

![](2024-08-06-11-07-33.png)

* Locally redundant storage (LRS): all three copies of data inside single availability zone (blue in diagram)
* zone redundancy storage (ZRS): three copies of data are distributed across availability zones (orange in diagram)
* geo-redundant storage (GRS): three copies of data within one AZ, three copies of data within another region's AZ (green in diagram)
* geo-zonal redudant storage (GZRS): three copies of data within one AZ, three copies in three AZs of another region (purple in diagram)
* read access geo-zonal redudant storage (RA-GZRS): three copies of data within one AZ set to read only, three copies in three AZs of another region (purple in diagram, but the Region 2 is read only)

### demo: creating storage accounts
* login to ARM
* Create a storage account
  ![](2024-08-06-11-10-41.png)
* blob storage access tiers:
  ![](2024-08-06-11-11-06.png)
* review storage account
  * all services have their own access points
  ![](2024-08-06-11-12-08.png) 

### summary
![](2024-08-06-11-12-21.png)

* `General purpose v2` is generally suggested


## conceptualizing azure blob storage

### describing azure blob storage
* Azure Blobs are a sub-resource of Azure Storage Accounts.
* Blob storage is object based and accessible via HTTP (REST).
* can store objects like: image and video files, text files, VHD files.

### components of blob architecture
* storage account
* blob service: a sub-resource for storage accounts.
* blob container: the container where we store our blobs.
* blobs: there data we store in the blob containers.

### types of blobs
* consider IO operations
* block blobs: storing images or videos, best suited for streaming.
* append blobs: log files
* page blobs: VHD disk storage

### container access levels
* access control applies at storage account level (or higher in the Azure resoruce access control hierarchy)
* in addition to the regular access control, there are boolean container level access control options
  * Private: no anonymous access
  * blob: anonymous access to blob
  * container: anonymous access to container and blobs it contains

### demo: config blob storage
* access ARM
* create a storage account with Allow enabling public access on containers option, if you wish
  ![](2024-08-06-11-33-23.png)
  * remember to review the access tier
* create a blob container within a storage account
  * within storage account, then expand dat astorage, then containers
  * create a new container
    ![](2024-08-06-11-35-08.png)
  * note that a container has a URL that provides access
    ![](2024-08-06-11-35-50.png)
* review access level in blob container access level
  * private access level
    * go to blob properties or even the container properties and grab the URL
      ![](2024-08-06-11-37-26.png)
  * container access level
    * can access blobs and the entire container
      ![](2024-08-06-11-38-35.png)
  * blob public access level
    * can only access blob, not the container
      * blob URL:
        ![](2024-08-06-11-39-22.png)
      * container URL:
        ![](2024-08-06-11-39-41.png)
* can change  access level
  ![](2024-08-06-11-40-39.png)
* can change storage tier for blobs
* review the blob service for a storage account properties (which will be the default properties for containers)
  ![](2024-08-06-11-41-40.png)


### summary
* blob service is object storage
* blob containers store blobs
* blob containers provide a flat-file structure

## configuring blob object replication

### describing object replication
* feature of storage accounts that allows asynchronously copies block blobs between storage accounts
* requires source and destination storage accounts
* requires enabling `versioning` and blob `change feed`
* supports cross-tenant replication (inter-region also!)

### conceptualizing object replication
* enabling `versioning` on both source storage account and destination storage account and blob `change feed` on source storage account.
* create a replication policy
* supports inter-region repl.

### benefits of object replication
* if blobs are local to region, then read latency is minimized
* increase efficiency: processing block blobs in different regions
* data distribution: processing and analyzing data in one location that repls to other regions
* cost optimization: moving repled data to the `archive tier` can reduce costs

### demo: configuring object replication
* login to ARM
* create storage accounts in different regions
  ![](2024-08-06-11-48-40.png)
  * enable versioning and blob change feeds as per guidance for source and destination
    ![](2024-08-06-11-51-17.png)
* create blob containers within the storage accounts
* config blob container repl
  * create an object repl policy
    ![](2024-08-06-11-52-21.png)
  * Create the rule
    ![](2024-08-06-11-52-46.png)
    * you can add a prefix filter for blob URI (such as path, file name, etc)

### summary
* enabling blob container repl requires
  * Versioning: on both source and dest storage accounts, must be enabled
  * change feed: on source storage account, must be enabled.
* repl policies: a single storage account can be a soruce for up to two dst accounts.  EAch policy supports only a single pairing using a policy ID.
* cross subscription and Entra ID tenant blob object repl is supported.

## configuring blob lifecycle management

### describing lifecycle managmeent
* capabilitiy for blog storage service feature that eanbles automation to manage lifecycle operations of blobs.
  * automate blob lifecycle: easily manage blob lifecycles from frequent use to archive or deletion
  * move blobs between contains on different access tiers: switch blobs between tiers to meet access or usage needs
  * optimize costs: save money by decreasing admin overhead and tiering blobs based on usage requirements (ie: location, speed, etc)

### conceptualize lifecycle management
* in a storage account, there's a blob container with blobs
  * this container is assigned a hot storage tier
* lifecycle management can automate moving blobs of a certain age to a cool, archive storage tiers or delete the blobs

### demo: configure lifecycle management
* login to ARM
* create storage account
* configure lifecycle management
  * in the storage account, go to data management/lifecycle management
    ![](2024-08-06-14-59-37.png)
    * can limit blubs:
      * with filters
      * by type
      * logic: last modified, created (more than N days ago), then move... etc.
      * filter set: blob prefix

### summary
* storage accounts requirement: support General Purpose v2 and blob storage accounts
* types and subtypes: support block and append blobs, and support subtypes: base blobs, snapshots, and version
* filtering: filter blobs in the rule using prefix or blob index matches
* scoping: scope at the storage account level or limit blobs by filters
* if/then logic applies in lifecycle rules based on mod and access times.

## LAB: Expire Data Based on Age in Azure Blob Storage
* Upload the Photos to Blob Storage
  ![](2024-08-06-15-07-11.png)
* Add a Policy to the `img` Folder
  ![](2024-08-06-15-08-54.png)

## configuring azure files

### describing azure files
* sub resource/service of Storage Account
* managed file share service that is cloud based
* SMB/NFS supported (windows, linux, macOS)
* Azure File Sync is supported
* provides traditional file structure

### components of Azure Files
* file service: azure Files service is a sub-ervice of Azure Storage storage accounts
* file share: the file structure we are connecting to locally
* Files and folders: exist in the file share

### connectivity options
* insecure connectivity: REST, SMB 2.1, 3.0 (inside network only), NFS
* secure connectivity: REST, SMB 3.0 (when outside of the network)
  * security: data encrypted at rest by default and in transit over HTTPS and SMB 3.0

### demo: working with Azure Files
* login to ARM
* create storage account
* create azure file share and connect with SMB client
  * within storage account, Data storage\file shares
    ![](2024-08-06-15-17-26.png)
  * edit quota to adjust max
  * within file share, can change tier
    ![](2024-08-06-15-18-35.png)
    * probably initially want to use transaction optimized, then change to hot or cool at a later point ot save on cost
    * with tiers, may or may not support lifecycle management
  * connect via a client:
    ![](2024-08-06-15-20-27.png)
    * AD sync or keys
    ![](2024-08-06-15-20-51.png)


### summary
* managed file share service: utilizes storage account redudancy and security
* OS clients: Windows, linux and macOS
* protocol support: SMB, REST, NFS
* File shares can have quotes, default is 5TB

## configuring azure File Sync

### describing Azure File Sync
* is an extension of Azure Files that allows you to extend the capabilities on-ppremises file servers
  * locally cache frequently accessed files
  * Requires Windows 2012 R2 or later
  * SMB, NFS, FTPS
  * requires File Sync agent

### components of Azure File Sync
* Storage Sync Service: high level Azrue resource
* Cloud endpoint: azure file share utilized in File Sync
* Registered Server: trusted on-prem file server

### File Sync Cloud Tiering
* enable on prem file share local caching and Azure Files share
* cached upon access not continuous sync

### demo: Configure Azure File Sync
* create File Share
  ![](2024-08-06-15-51-26.png)
* create an Azure File Sync resource
  ![](2024-08-06-15-53-23.png)
* the File Sync resource must be in the same region as the Azure File file share
  ![](2024-08-06-15-54-02.png)
* within the File Sync resource, go to sync\getting started and it will explain how to onboard the Registered Server (on-prem server that will be the sync partner to the Azure File resource).
  * Windows server: disable IE security enhanced configuration mode
  * install the Azure powershell module
    `install-module -name az`
  * create a new folder on the server
  * download and install the Azure File Sync agent
  * set up the Registered Server
    * AzureCloud env
    * Authenticate to Azure
    * choose the storage sync servers
      ![](2024-08-06-15-58-44.png)
    * Once registered, the Registered Server will be visible in Azure Storage Sync UI in ARM
      ![](2024-08-06-15-59-55.png)
  * in the Storage Sync service, click on Sync group and create
    ![](2024-08-06-16-00-46.png)

### summary
* Azure File Sync:
  * extends on-prem file share: increases storage capacity through cloud tiering
  * Windows only: windows 2012 R2 or later file servers only
  * Requires File Sync Agent: download Azure File Sync agent onto local file server

## LAB: create and restore file share snapshots in Azure
* create a storage account
  * yarp
* in the storage account go to Data STorage\ File Share and create a new file share
  ![](2024-08-06-16-06-29.png)
* grab the script to connect for the file share
```
  $connectTestResult = Test-NetConnection -ComputerName foosa.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
    # Save the password so the drive will persist on reboot
    # Mount the drive
    New-PSDrive -Name Z -PSProvider FileSystem -Root "\\foosa.file.core.windows.net\foosa" -Persist
} else {
    Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
* execute the script on a compatible Windows OS client
* Create a file with contents in the share on the Windows OS client
  ![](2024-08-06-16-09-50.png)
* verify in the Azure File Share that the file is present
  ![](2024-08-06-16-10-23.png)
* add a snapshot
  * yarp
* append some data to the file
  ![](2024-08-06-16-11-58.png)
* restore the old verison of the file fromt he snapshot
  ![](2024-08-06-16-12-41.png)
* verify old file is restored
  ![](2024-08-06-16-13-16.png)

## storage network access

### storage access options
* public endpoint: all services are public by default using the service's public endpoint URL.
* restricted access: storage account access can be restricted to VNets, IP addres ranges via the storage account's firewall, and via specific resource instances.
* private endpoints: allow private IP access for resoruces in an associate VNet.

### public endpoints
![](2024-08-06-20-18-20.png)
* storage account firewall does restrict access
* Each service type has a public endpoint: blog service, table service, file service, queue service.

### providing network access to service and resources in storage account
* access storage account
  ![](2024-08-06-20-18-48.png)
* some services, (ie: blob container) although they have a public endpoint, may have additional protection (ie: blob container access level [private, blob, container]).
* restricting network access to the storage account (and it's included service resource instances)
  ![](2024-08-06-20-22-22.png)
* can restrict to VNets or IP ranges:
  ![](2024-08-06-20-23-19.png)
* can restrict to resource instances
  ![](2024-08-06-20-23-53.png)
* PRivate endpoint connections and custom domains are available
  ![](2024-08-06-20-24-46.png)

### summary
* proviate network access, each sub-service has an endpoint
* endpoints have a:
  * public endpoint
  * restricted access
  * private endpoint

## securing storage accounts

### Azure Storage encryption
* by default, all data storage (data at rest) in any Azure storage service is secured using Storage Service Encryption (SSE).
* All data in transit can be secured using TLS (HTTPS).

### Azure Storage authentication
* management layer: Azure RBAC
* data layer: also leverages Azure RBAC
* can grant access via:
  * Access keys: azure-generated keys that provide unlimited access to bother the mgmt and data layer of an Azure Storage solution
  * Shared Access Signature (SAS): an access signature, generated from access keys, that provides limited access to either the account level (Storage Account) or the service level (blob container).
  * Entra ID auth: users azure RBAC and Entra ID identities to provide authentication (instead of access keys).

### demo: securing storage accounts
* access storage account
* verify TLS encryption is available, blob public access may be enabled then administrator via container access, storage account key access being disabled (will revoke existing keys)
  ![](2024-08-06-20-31-55.png)

#### access key administration
* there are two keys per storage account to provide for reasonable rotation of keys
![](2024-08-06-20-33-58.png)
* the access keys provide full access to the Storage Account ... they can not be restricted.
* these keys are referred to as "account keys" when you access attempt to generate a shared access signature for any service instances/resources contained within the Storage Account
* Shared access signatures can be used to restrict access (this is leveraging a signing key)
  ![](2024-08-06-20-34-47.png)
  * yea....
    ![](2024-08-06-20-36-15.png)

#### SAS can also be generated at the resource ("service") level 
* they can be signed by:
  * the account (access) key
  * user delegation key
    * the user delegation key leverages the currently logged in Entra ID user to generate the key, and uses their IdP granted permission restrictions.
    * yea...
      ![](2024-08-06-20-42-36.png)
* you can adjust the authentication method at the resource/service level
  ![](2024-08-06-20-45-46.png)
  * you need specific permissions to generate a user delegation key (for example)
    ![](2024-08-06-20-46-56.png)
  * remember that DataActions are not Actions (aka: Management Actions)...
    ![](2024-08-06-20-47-55.png)
* This is mad confusing bruh
  ![](2024-08-06-20-59-11.png)
* how about some benefits and comparisons
  ![](2024-08-06-21-00-34.png)
  ![](2024-08-06-21-00-51.png)
  ![](2024-08-06-21-01-02.png)


#### Storage Access Policies
![](2024-08-06-20-49-03.png)
* this allows an Entra ID user to generate a shared access signature for a given policy (only, if restricted as such)

#### Azure Defender for storage
![](2024-08-06-20-52-26.png)
* detects potentially harmful attempts to access or exploit blob containers and file shares in your storage accounts.

### summary
* storage accounts are encrypted default encryption with keys managed by microsoft
* you can secure the management and data layer
  * using access keys
  * using SAS
  * using Entra ID authentication (RBAC)

## LAB: limit access to azure storage account using SAS URI
* open Azure Storage Explorer
* connect to Azure resource
* select "Storage account or service"
* select SAS as the connection method
* go the ARM
* access a storage account
* create a new container
* upload some files
* go back to the storage account main screen
* go to settings/configuration
* Allow storage account key access: enable
* on the storage account...
* go to security + networking / shared access signature
* adjust the SAS settings
  ![](2024-08-06-21-10-51.png)
* copy the blob service SAS URL
* Go back to Azure Storage Explorer instance and paste the SAS URL
  ![](2024-08-06-21-12-03.png)
* Navigate to the blob container and check out your blob read access (set above)
* TRy to delete and notice the failure
  ![](2024-08-06-21-14-22.png) 

## Using Azure Jobs

### describing Azure Jobs
* move large amounts of data between on-prem and Azure Storage in case there isn't enough bandwidth, etc
* move to/from Blob service
* move to Files service
* transport self-supplied drive
* Supported drive types: SATA, HDD, SSD

### import jobs
* prepare disks (WAImportExport)
* create job
* ship drives
* check job status
* receive the disks back
* check data inside Azure Storage

### export jobs
* create job
* ship drives (WAImportExport)
* check job status
* receive and unlock disks

### demo: moving data
* login to ARM
* access a resource group and review Storage Account
* access "import/export jobs" in the resource search bar
* create a job
  ![](2024-08-06-21-23-30.png)
  * you must provide carrier name
  * if export: select blobs to export

### summary
* move large amounts of data between on-prem and Azure Storage in case there isn't enough bandwidth, etc
* Import jobs: send large amounts of data to the Azure cloud when network bandwidth won't support data migration
* Export jobs: receive large amounts of data on-prem from azure cloud when entwork bandwidth won't support data migration (for BLOBs)
* WAImportExport CLI tool: use to prepare disks for data and to estimate number of disks needed.
* Windows support only
* Azure Blob and Files

## Storage utilizeies

### describing utilities
* Storage explorer: GUI tool for working with storage accounts (supported for windows, linux, and macOS)
* azcopy: a CLI utility for workignw ith storage accounts  (supported for windows, linux, and macOS)

### demo: using storage utilities

#### storage explorer
* login to ARM
* access a resource group/storage account
  * click on storage explorer (not all options)
  * you can download and install Storage Explorer thick client
* when connecting, you can use your Entra ID cred, or you can connect to a storage account using:
  * a connection string
  * a SAS (restricted permissions with expiry)
  * an account name and key (remember this grants unrestricted permissions to everything)
* to get the key, go to the storage account/security+networking/access keys

#### azcopy
* download azcopy
* login: `azcopy login`
  ![](2024-08-06-21-32-50.png)
* Create a resource
  ![](2024-08-06-21-33-58.png)
* copy file
  ![](2024-08-06-21-34-38.png)


### summary (storage explorer vs. AzCopy)
* storage explorer
  * manage storage accounts
  * use Entra ID or SAS to auth
  * gui provided
  * uses AzCopy under the hood
* azcopy
  * manage storage accounts
  * use Entra ID or SAS to auth
  * CLI tool == scripting capabilities

# sanity check

<img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto"><img src="sanity_check_1_20.webp" alt="image" width="30" height="auto">

* SAS tokens really blew my mind.  They seem overly complex to acheive a very simple thing, but I bet if I had some use cases for them, then I'd understand.  I'm bias towards not liking shared secrets, but there are uses for them as answered by chatgpt above.  For example, consider granting access to blob storage from a mobile app... and others (https://chatgpt.com/share/b520eaa2-0992-4a4b-b14c-d6456153f09f)

## how burned out do I really want to be?

* Let's take a sanity check on time left here
  * theory: 8.5 hours
  * labs: 14 labs left... ~15 mins per lab == 210 mins
  * total time estimate ~13 hours

# Virtual networks

## Conceptualizing Virtual Networks

### describing networks
* purpose of a network: a network allows a client to have an isolated network where resoruces cna communicate with one another and with outside networks
  * users accessing file servers
  * printer sharing
  * web servers
  * app server accessing database servers and internet

### traditional vs. virtual networks
* virtual networks can do alot of the same things as traditional
  * subnets
  * hosts
  * network security groups (firewall) can be placed on the subnet or network interface of a resource
    * can control both public and private traffic
  * can assign a public IP address
  * automatically routes for public and private networks

### describing virtual networks
* isolated network: VNets are isolated networks on the Azure cloud (SDN)
* private network access: provides private connectivity between resources like VMs or App Services
* network integration: allows connectivity between VNets, on-prem networks and remote user devices

### components of virtual networks
* address space: the private addr space for the isolated network.  Required to provide resources with private IPs.
* VNet: the isolated network on Azure cloud where Azure resources like VMs are deployed
* subnet: the segmentation of the isolated network into smaller sub-networks where resources will exist

### summary
* purpose of a network: a network allows a client to have an isolated network where resoruces cna communicate with one another and with outside networks
* isolated network: VNets are isolated networks on the Azure cloud (SDN)
* private network access: provides private connectivity between resources like VMs or App Services
* network integration: allows connectivity between VNets, on-prem networks and remote user devices

## creating virtual networks

### designing a network
* determine CIDR: select a CIDR notation that allows for growth and intergration
* subnetting requirements: determine how to segment the solution to meet your needs, such as segmenting for n-tiers
* connectivity needs: determine what type of connectivity is needed: internet, resource ot resource, resource to service, etc.

### VNet features
* subnetting: azure VNet uses subnets to segment addr spaces.  Reserved IP addrs are: x.x.x.0-3 and x.x.x.255
  * note that the DHCP server is built in to the VNet
* private networking: azure VNet supports DHCP for private ip addr for resources
* public networking: azure VNet supports public IP addr (ipv4 and ipv6) so that resources can have public connectivity
* peering: azure VNet supports peering between Azure VNets (across regions and within regions)
* network gateway: azure VNet uses gateway subnets to make VPN connections (for on prem networks, remote networks, remote user devices)
* monitoring: VNet makes monitoring easi.  view logs, monitor connectivity and view a topology of the virtual network.

### demo: creating a VNet
* goals:
  * CIDR 10.0.0.0/16
  * default subnet 10.0.0.0/24
  * VM at 10.0.0.4
* login to ARM
* access virtual networks and set ip addresses (CIDR as small as /29, as large as /8), create
  ![](2024-08-07-10-02-53.png)
* create a new subnet
  ![](2024-08-07-10-04-19.png)
* Can assign custom DNS servers
  ![](2024-08-07-10-05-43.png)
* access virtual machines create a VM
* on networking select the subnet
  ![](2024-08-07-10-06-29.png)
* access the VNet
  ![](2024-08-07-10-07-00.png)
  * you can modify the ip address via the VNet config

### summary
* default connectivity: by default, intra-network traffic and outbound internet traffic is allowed
* addres restrictions: use of private addr using RFC1918.  The smallest vnet subnet size is /29, largest /8
* reserved IPs: x.x.x.[0-3] and x.x.x.255
* DNS and DHCP are provided: but DNS can be customized
* network integration: VNets are built for integration with one another, hybrid connectivity using VPNs and ExpressRoute
* VNet protocol support: TCP, UDP, ICMP

## LAB: Create Multiple Subnets in Azure
* Create a New Subnet to existing VNet
  * yarp
  * 10.0.1.0/24
* Create New Network Security Group Rules
  ![](2024-08-07-10-13-42.png)
  * create a deny rule inbound
    ![](2024-08-07-10-16-54.png)
  * create a deny rule outbound
    ![](2024-08-07-10-18-33.png)
* Move the VM to the New Subnet
  ![](2024-08-07-10-19-32.png)
  * apply a subnet change
    ![](2024-08-07-10-20-27.png)
    * the VM will be restarted right when Apply is clicked

## deploying network resources

### IP addressing
* private connectivity: VNets can be used to provide private comms between resources (no public network access)
* public connectivity: VNets can be used to provide publicly resolvable address for resources
* IP CIDR planning: plan networks ot prevent overlap in network address space to allow for network integration

### types of IPs
* private IPs: static or dynamic assigned addr that allow private connectivity between resources
* public IPs: static or dynamic assigned addr that allow public connectivity **from** the internet to a resource
  
### public IP SKUs
* basic SKU: static or dynamic assigned public IP that is **accessible by default** and requires an NSG to restrict traffic.  Does not support availabiity zone deployment
* Standard SKU: statically assignable public IP that is **not accessible by default** and rquires an NSH to allow traffic.  Supports AZ deployment

### demo: NIC IP Configs
* can have both an private IP (required and a public IP
* access ARM
* resource groups/ virtual network/ verify one is created
* select network interface in search bar > create
  * VNets are bound to regions
  * select the subnet
* select public ip resource in search bar
  * ipv2
  * sku: standard, basic
  * tier: regional, global
  * routing preference: MSFT network or internet
* access the newly configed network interface> ip address
  * you can choose a public IP addr (must be region local)
* create a VM
```
az vm create --resource-group [as is] --name net-demo-vm01 --image UbuntuLTS --admin-username fooadmin --generate-ssh-keys --nics nic-01
```
  * reviewing the output you can see the public IP

### summary
* network interface cards have:
  * private ip and public ip
* private IPs: static or dynamic assigned addr that allow private connectivity between resources
* public IPs: static or dynamic assigned addr that allow public connectivity **from** the internet to a resource
  * basic SKU: static or dynamic assigned public IP that is **accessible by default** and requires an NSG to restrict traffic.  Does not support availabiity zone deployment
  * Standard SKU: statically assignable public IP that is **not accessible by default** and rquires an NSH to allow traffic.  Supports AZ deployment

## routing VNets

### describing routing
* routes: paths for connectivity
  * ie: a route allowing VM to comm with the internet outbound

### routing types
* system routes: default route that are built-in to virtual networks that cannot be modified
* custom routes: user-defined routes or BGP routes that override system routes.
  * ie: custom route that blocks non RFC1919 addresses

### routing scenario
* user-defined routes: routes created by users that take precedence over all routes
  * overriding routes to the internet to either go to nothing or go to a network virtual appliance (NVA) like Azure Firewall.
* BGP routes: routes that are exchange between integrated networks
  * hybrid networks or VNet peering

### creating routes
* access ARM
* go to resource group
* VNet created, VM created, NSG bound, NIC bound
* access NIC
  * go to support + tshooting / effective routes
    ![](2024-08-07-10-53-10.png)
* go to search bar: route table
  * create route table
    ![](2024-08-07-10-53-47.png)
  * access route table
    * go to settings/routes
    * add a route
      * specify the address prefix (destination CIDR)
      * next hop types
        ![](2024-08-07-10-54-43.png)
        * none == block/drop
    * go to settings/subnets
      * associate -> select VNet and subnet to associate the route
* recheck effective routes on NIC resource, review "State
  ![](2024-08-07-10-56-26.png)

### summary
* system routes: default route that are built-in to virtual networks that cannot be modified
* custom routes: user-defined routes or BGP routes that override system routes.
* order of precedence:
  * custom routes (highest)
  * BGP
  * system routes (lowest)

## Network Security Groups

### defining NSGs
* NSGs control the flow of traffic
  * an NSG controls the traffic flowing through a VNet
* creating rules that define what is allowed/denied
* controlling security at the subnet or NIC
* specify priority

#### functions
* filter traffic: determining what trafic will be allowed or denied inbound and outbound
* rules: evaling default rules that cannot be deleted and user-defined rules that can be created
* priority: specifying priority to roder the precedence of rules.  the lower the number, the higher the priority
  * user defined rules can use priority nubmers of 100-4096

#### how are NSGs bound
* association an NSG has no effect unless associate to either a subnet or NIC
* precedence: the traffic metadata will qualify which rules apply to the traffic.  Once a rule is matched, no other rule is processed.

#### what it looks like
![](2024-08-07-11-02-23.png)
* deny all, but allow outbound by specificity

### architecting NSGs

![](2024-08-07-11-04-52.png)

* VNet has subnet, VM is in subnet, VM has NIC
* NSG can be bound to subnet
  * allow SSH inbound
  * allow HTTP inbound
  * Allow internet outbound
* NSG can be bound to VM NIC
  * deny all inbound
  * allow internet outbound
* effective access flow:
  * everything denied to VM NIC except outbound internet

### Implementing NSGs
* access ARM
* vnet created
* VM created (linux)
* NIC bound with public IP (obtain public IP from accessing resource group )
  * test SSH connectivity from your workstation == fail
* create NSG (remember they must be in the same region as other networking resources)
  ![](2024-08-07-11-06-53.png)
* verify the rule stack and then add a new inbound security rule allowing tcp/22
  ![](2024-08-07-11-07-55.png)
* NSG must be bound to NIC or subnet
  ![](2024-08-07-11-08-33.png)

### summary
* network security groups control traffic
* NSGs are stateful
* NSG are used for
  * filter traffic: determining what trafic will be allowed or denied inbound and outbound
  * association: must be associated to suybnet or NIC
  * rules: evaling default rules that cannot be deleted and user-defined rules that can be created
  * priority: specifying priority to roder the precedence of rules.  the lower the number, the higher the priority
    * user defined rules can use priority nubmers of 100-4096
  * there must be effective access flow... remember NSGs are bound to subnet (inter-subnet including internet) and/or NIC (east-west)

## LAB: create an application security group for two web servers in Azure
* `application security groups` can be used as a source of destination for NSGs (sort of like object groups in a firewall)
* access ARM
* access Resource Group
* note presence of VMs and NSGs and their region
  * go to NSG and understand association between VM networks and the NSG
* create an Application Security Group (must be in same region as other resources)
  ![](2024-08-07-11-17-09.png)
* access VM1 / networking/ network settings > under essentials> application security groups> configure
  ![](2024-08-07-11-19-49.png)
  * access VM2 and do the same
* go to NSG and add an inbound rule
  * destination "application security group"
  ![](2024-08-07-11-23-27.png)

## Using Azure DNS

### describing Azure DNS
* A DNS hosting service that provides name resolution
* implemented using:
  * records/record set
  * supports: A, AAAA, CNAME, TXT, MX, PTR, SRV and SOA
  * supports private and public zones

### describing Record Sets
* split between public and private zones
  * record: a single IP address
  * record set: multiple records associated with the same name

### describing Alias Records
* records that are allow for a link to a resource

### demo: creating a DNS zone
* login to ARM
* access RG
* build:
  * VNet, two VMs, NICs, two public IPs for NICs
* search bar> DNS zones> create
  ![](2024-08-07-12-01-43.png)
* access the newly created DNS Zone (this is ap ublic DNS zone)
  * add the name servers to registrar if you need to use Azure DNS as your authoritative DNS
* Create Record Set
  * grab public IP of DNS and bind
    ![](2024-08-07-12-03-12.png)
  * or can use an Alias record
    ![](2024-08-07-12-03-41.png)
* search bar > private DNS zone> create
  ![](2024-08-07-12-04-59.png)
* go to SEttings/Virtual network links
  ![](2024-08-07-12-06-23.png)
  * auto registration so that VMs in VNet will automatically register
* review Private DNS zone
  ![](2024-08-07-12-12-05.png)


### summary
* features:
  * RBAC (this wasn't covered :) )
  * activity logs (this wasn't covered :) )
  * resource locking (this wasn't covered :) )
  * private DNS zone
  * alias records

## using azure firewall

### describing azure firewall
* PaaS firewall to filter traffic
* FQDN support
* NAT, applications rules

### azure firewall features
* DNAT and SNAT: configure outbound/inbound xlate rules for your networks
* NEtwork rules: configure layer 4 rules for what traffic is allowed
* app rules: configure rules for filter websites visited from your network
* threat intel: identify malicious IPs and domains
* monitor: integrationw ith Azure Monitor to capture firewall traffic

### implementation steps
* create a VNet
* create subnet named "AzureFirewallSubnet" of a /26 or smaller
* create an Azure Firewall instance
* create/modify a routetable resource and add a route to route traffic to the firewall (gateway)

### demo: implement azure firewall

#### perform networking config for the firewall

* access ARM
* config: VNet, 1 VM, 1 NIC, 1 public IP bound, 1 NSG bound to VNet subnet
  * subnet already created
* go to VNet and create a new subnet called `AzureFirewallSubnet`, and create a /26
  ![](2024-08-07-15-44-30.png)
* go to resource search bar> Firewall> Create
  * must have same region as existing VNet
  ![](2024-08-07-15-45-07.png)
  * we are using Classic rules not a Firewall Policy
  * use existing VNet
  * add a public IP address
* create a route table
  * go to route table
  * create a new route
    * address prefix is 0.0.0.0/0
    * NExt hop type is virtual appliance
    * next hop address:
      * obtain this from the firewall resource summary page from the firewall resource you created earlier
      ![](2024-08-07-15-47-50.png)
  * associate the subnet with the route table via the route table config/settings/subnets/associate

#### create rules in the firewall
* go to the created firewall resource
* copy the public IP of the firewall
* go settings/rules (classic)
* add NAT rule collection
  ![](2024-08-07-15-51-52.png)
  * use the dst address is the public IP of the firewall
  * the translated address is the target VM address

### summary
* create a new subnet called `AzureFirewallSubnet`, and create a /26
* must create a route
* options for rules:
  * Nat rules
  * NEtwork rules
  * Application rules

## LAB: Attach a Firewall to a Virtual Network in Azure
* n/a lmao

## using service endpoints

### accessing PaaS services
* by default, MSFT services have a public endpoint.
  * a VM will access an Azure file share from a storage account using a public endpoint

### describing service endpoints
* using service endpoints, you can provide private connectivity to a service from inside your virtual network.
  * a VM will access an Azure file share from a storage account using a service endpoint
* doesn't 

### service endpoint considerations
* enabled per subnet
* not all services are supproted
* support services differ per region
* deoes not give services a private IP
* provides source IP as private IP
* firewalls can enhance security (optional)

### demo: configuring a service endpoint
* login to ARM
* access subnets
* Review Service Endpoints
  ![](2024-08-08-04-37-23.png)

* can check off per service
  ![](2024-08-08-04-37-44.png)
* you can use azcli to list which service-endpoints are available per region
```
az network service-endpoint list --location southcentralus
```
* you can also add and/or list the service endpoints from the UI
  ![](2024-08-08-04-39-54.png)
* you can also review NIC effective routes
  ![](2024-08-08-04-40-52.png)
* service endpoint policies can also be set up and bound to subnet service endpoint access configs
  ![](2024-08-08-04-41-50.png)
* You can set up a service tag as a destination in an NSG
  ![](2024-08-08-04-43-17.png)
  * as noted, you can create a higher priority NSG rule to deny traffic to the internet from the subnet.

### summary
* using service endpoints, you can enable private connectivity to your serivces
  * decreases attack surface
  * enables use of NSG rules
  * enhanced routing

## Using Private Endpoints

### describing private endpoints
* usign Azure Private Link, you can connect your services as connected resources in your network with a private IP known as a private endpoint
* private endpoint connectivity for:
  * azure services
  * customer/partner services
* provides direct service (sub-resource) mapping
* connections can be sourced from... almost anywhere to the private endpoint:
  * from other VNet subnets
  * from on-prem networks

### demo: creating a private endpoint
* login to ARM
* go to VNet config
* VM has a NIC with a private IP
* Go to Private Endpoint and see none
  ![](2024-08-08-04-57-36.png)
* go to the resource search bar and type in Private Link/Private endpoints
* create a new private endpoint
  ![](2024-08-08-04-59-17.png)
  * you are specific to a sub-resource
* this assigns a resource instance a private IP address
  ![](2024-08-08-05-01-26.png)

### summary
* a private endpoint provides
  * a private IP for your connected services
  * connectivity to Azure services
  * connectivity to customer/partner services
  * direct service (Sub-resoruce) mapping

# intersite connectivity

## configuring azure VNet peering

### describing VNET peering
* default connectivity: while intra-network traffic and outbound internet traffic is allowed, virtual networks are by default isolated
* VNet peering: bridge together VNets to allow connectivity between these networks
* non-reciprocal: connection must be established in both directions
* global connectivity: peerings can be same region or cross-region (global)
* non-transitive: you need to establish a VNet to connect to another VNet directly, you can traverse a peered VNet to another VNet

### benefits
* low latency, high bandwidth connections (MSFT backbone)
* cross-network comms
* data transfer between/across
  * subscriptions
  * Entra ID tenants via Azure roles
  * azure regions

### demo: implementing
* access ARM
* go to a VNet/settings/Peerings
  ![](2024-08-08-05-09-40.png)
  ![](2024-08-08-05-10-01.png)
  * note that although a single peering is non-reciprocal, the config creates two peerings

### summary
* types of peerings
  * virtual network peerings
  * global virtual network peering
* benefits:
* low latency, high bandwidth connections (MSFT backbone)
* cross-network comms
* data transfer between/across subscriptions, Entra ID tenants via Azure roles, azure regions
* transitivity: peering connections are non-transitive
* reciprocity: peering connections are not reciprocal

## Implementing VPNs

### VPN Gateway vs. VNet peering
* VPN Gateway: establishes conenctivity between VNets simiarly to VNet peering
* components:
  * VNet gatway for VPN gateway
  * Gateway subnet
  * Public IP per VNet gatway
  * IPsec tunnel for encryption

### capabilities of VPN Gateways
* S2S and P2S:
  * remote users to Azure VNets (P2S)
  * on prem networks to Azure VNets (S2S)
* VPN Gateways allow for transitive traffic

### routing types and VPN gateway SKUs
* Policy based:
  * static routign via policy declarations
  * legacy on prem VPN devices
  * only supports IKEv1
  * only Basic SKU
* Route base
  * static and dynamic routing
  * resilient to topology changes
  * can coexist with ExpressRoute
  * supports IKEv2

#### SKUs
![](2024-08-08-06-08-59.png)

### active-active vs. active-passive

#### active-active
* two VMs each running an active tunnel
* additional config requirements
  * two separate public IPs with VPN Gateway
  
#### active-standby
* default config 
* one VM running one tunnel at a time
* if VM dies, then secondary VM spins up and reconnects


## demo: implementing VPN Gateway
* CIDR for Azure VNet 10.0.0.0/16
* On prem network: 172.16.0.0/16
* create "GatewaySubnet" 10.0.0.0/27
  * must use the name "GatewaySubnet" for subnet name
  * must use a /27
* create a virtual network gateway
  ![](2024-08-08-06-13-53.png)
  * select the VNet
  * assign a gateway subnet address range
  * create a public IP
* create a local network gateway
  ![](2024-08-08-06-15-32.png)
  * the IP address here is the public IP of the source VPN server
  * the address space here is this side's subnet
* Create a connection
  ![](2024-08-08-06-17-14.png)

### summary
* Config steps:
  * create VNets and Subnets
  * specify the DNS server
  * create GatewaySubnet
  * Create the VPN Gateway
  * Create a Local NEtwork Gateway
  * Configure the VPN device on prem
  * Create the VPN connection
* connections options
  * VNet-to-VNet
  * Site-to-Site
  * Point-to-Site

## Configure ExressRoute

### describing ExpressRoute
* physical connection to connect into Azure Cloud to access resources
  * M365
  * VNets
  * PaaS (even without a private)
* Edge Locations
  * Microsoft Edge: MSFT side connection
  * Partner Edge: our partner's edge
* primary and secondary connection to Partner, and Partner has multipath connection to MSFT
* "MSFT peering" to M365
* "Private Peering" to Azure VNet
* on prem: need an ASN# and VLAN ID, create two /30 subnets, shared key, MSFT peering requires public IP addresses

### Implementation Steps for an Expressroute
* create ExpressRoute Circuit
* give service key to third party Provider
* create peering configs: note that this step will be part of step 2 if the provider only offers layer 3 connectivity instead of layer 2.
* create VNet Gateway: the gateway type must be ExpressRoute and it must be deployed into a gateway subnet.

### demo: Configuring ExpressRoute
* login to ARM
* create new ExpressRoute circuit
  ![](2024-08-08-06-30-16.png)
  * SKUs
    ![](2024-08-08-06-31-11.png)
  * billing model: pay for outbound to MSFT resources
* create Virtual network gateway
  ![](2024-08-08-06-32-47.png)

### summary
* Azure ExpressRoute
  * dedicated physical connection
    * partners offer PoPs in data centers
  * built-in redundancy
  * connectivity to MSFT
  * connectivity via private peering (Azure resources)
  * dynamic routing via BGP
  * 50Mbps-10Gbps

## implementing Virtual WAN

### describing Virtual WAN
* a networking service that provides a single itnerface that helps manage hub-and-spoke style networks
* can manage firewalls and routes through a single pane of glass
* can create a single Virtual WAN hub in each region

### Hub-to-Hub connectivity
* you can have hub-to-hub connectivity to between regions

### Virtual WAN SKUs
* Basic:
  * transitive peering not supported
  * S2S VPN connections only
  * Upgrade to Standard supported
* Standard:
  * Transitive peering supported
  * S2S, P2S VPNs, ExpressRoute and VNet-to-VNet connection

### demo: creating an Azure WAN
* login to ARM
* go to resource search box: virtual WANs> Create WAN
  ![](2024-08-08-07-57-29.png)
* Configure the VWAN
  ![](2024-08-08-08-01-49.png)
  * give it a "Hub private address space" for the Hub network
  * Can create additional items now or later:
    ![](2024-08-08-08-04-40.png)
* Verify Hub connectivity
  ![](2024-08-08-09-02-49.png)

### summary
* azure Virtual WAN
  * single operational interface where we manage fully manage networks
  * Connect networks using hub-spoke architecture
  * basic (S2S VPN connections only) and standard SKUs
  * connect S2S and P2S VPN gateways, global reach ExpressRoute, and VNets
  * secure with Azure Firewlal and Firewall Manager
  * Any-to-any connectivity
  * Connections propagated to managed routes
  * Hubs are Managed Virtual Networks

## LAB: Create a Hub-spoke network topology in Azure

### lay out

![](2024-08-08-09-06-59.png)

### procedure
* Configure the Virtual Network Gateways
  * verify both are VpnGw2 SKUs to provide VNet-to-VNet
  ![](2024-08-08-09-08-18.png)
  * deploy the Connections for both directions:
    ![](2024-08-08-09-11-46.png)
  * change settings for connections
    ![](2024-08-08-09-12-23.png)

# Azure VMs

## creating and managing VMs

### what is an VM
* scalable cloud compute resource offered as IaaS
* includes: CPU, RAM, storage and networking resources (no worries about hardware or physical infra)
* can be created from Azure ARM, Azure CLI, or Powershell

### defining VMs
* core ports
  * CPU and memory: determined by VM sizing, selected based on use case.
  * Networking: VNets, subnets, NIC (private and public IP), and NSG
  * storage: azure Disks, consisteing of OS disk, temporary disk, and an additional data disk

### VM workload families
![](2024-08-08-09-15-47.png)

### VM properties
* VMs have:
  * NIC, Disk, Public IP
  * name:
  * region:
  * size:
  * image: 
* deployed to a resource group

### VM architecture
* resource group VM relevant resources:
  * VNets
  * Subnets
  * VM's NICs will be attached to a VM
  * Disk
  * public IP

### demo: create VM
* create a linux VM: use azure protal, azcli, or powershell via the cloud shell.
  * on VM:
    ![](2024-08-08-09-20-55.png)
* Configure disks: add a data disk to the VM
* config networking: select or create VNet, subnet, NIC Public IP and NSG
* install web server: install nginx using custom data
  * using cloud-init script
    ![](2024-08-08-09-22-15.png)
* open NSG for http: manage sec rules for VM (in the relevant NSGs)

### summary
* VMs provide OS instances, are compute resources
* allows migrate workloas
* compute resources are elastic

## Managing VM disks

### what are VHDs
* VHDs: a file representation of what is found on a hard disk.
* VMs use VHDs to store OS, apps and data.  VHDs utilize the underlying storage infra in page blobs.

### purpose of VHds
![](2024-08-08-09-25-23.png)

* OS disk:
  * default with VM
  * storage OS
  * registered as a DATA drive
  * C: or /
  * max capabity 4TB
* Temporary disk:
  * default with VM
  * storage non persistent data like page and swpa files
  * local disk for underlying MSFT infra
* Data disk:
  * additons disks attached to a VM
  * used for storing persistent data like files or DBs
  * registered as a SCSI device
  * Max cap 32TB

### unmanaged vs managed disks
* managed disks:
  * managed by ARM
  * azure managed storage accounts
  * availability support
  * RBAC
  * snapshot support
  * backup support
* unmanaged risk
  * not in ARM
  * manually manged storage accounts
  * availability not guaranteed

### disk types

![](2024-08-08-09-27-33.png)

### disk encryption
* at rest
* Storage Service Encryption (SSE)
  * encryption of physical disks in data centers
  * built into Azure
* Azure Disk Encryption (ADE)
  * optional encryption of the VHDs
  * ensures a disk is only accessible by the VM that owns the disk
  * OS tools like bitlocker and dm-crypt

### demo: create a VM and attach a disk and encrypt the disk
* on a VM:
  * add a data disk to a VM
     ![](2024-08-08-09-29-52.png)
  * enable azure disk encryption using ADE
    * go to additional settings on the Disk settings screen
    * select the disk to encrypt:
      ![](2024-08-08-09-30-19.png)
    * create a new key vault
      * check off acess to Azure disk encryption for volume encryption
      ![](2024-08-08-09-31-18.png)
    * create a new key
      ![](2024-08-08-09-32-20.png)
    * apply the key to the disk settings
  * validate encryption
    ![](2024-08-08-09-33-32.png)

### summary
* Azure Disks are VHD
* OS disk, temporary disk, data disk
  * disks are stored as page blobs
* SSE == physical encryption on disks
* ADE == key based encryption for data

## LAB: add existing data disk to a VM in Azure
*

## configuring VM availability sets
* global infra and HA provides availability and scalability capabilities
* AZ has:
  * many regions
  * many AZs in the regions

### Availability Sets
* protect redundant VMs
* protect againt underlying host failures caused by network or pwoer outages
* Fault Domain: a rack where network and power are shared (max FDs: 3)
* Update domain logical grouping of infra for maintenance updates to hypervisors (max UD: 20)

### demo: reviw availability sets
* go to ARM> search Availability sets> create
  ![](2024-08-08-10-04-38.png)
* Review VMs
  ![](2024-08-08-10-05-15.png)
* add VMs to availability set
  ![](2024-08-08-10-05-58.png)
* two VMs in each fault domain and update domain:
  ![](2024-08-08-10-06-41.png)

## configuring VM scale sets

### autoscaling operations
* VM scale sets
  * based on rules, VMs will multiple and/or reduce
  * the VMs are identical
  * simplify scaling configs
  * save costs by aliging usage with demand
  * scale to meet demand of traffic

### components:
* VM definition: define VM size, OS, NICs, storage, etc
* autoscaling definition: define scaling actions, scaling in/out based on constraints met
* scale-in policy: delete VMs by priority as scaling-in operations occurs

### demo: create a scale set
* ARM> virtual machine scal esets> create
  ![](2024-08-08-10-10-01.png)
  * can be scaled across AZs
  ![](2024-08-08-10-11-20.png)
  * adjust scaling policy
    * scaling out/in
      ![](2024-08-08-10-11-51.png)
    * scale in policy
      ![](2024-08-08-10-12-12.png)
* similar VM creation options
* similar management options to a VM
  ![](2024-08-08-10-14-00.png)
* review scale settings
  ![](2024-08-08-10-14-36.png)

### summary
* HA: design highly avialable solutions using zonal redudant deployment
* Availability Sets: provide protection for redundant VMs by preventing outagesw related to faults and updates by logically groupign them into domains
* scale sets: autoscale solutions to meet demands of traffic and scale in to decrease costs when demand goes down

## LAB: Use PowerShell to Resize an Azure Virtual Machine in an Availability Set

* Start Cloud Shell
* Get-AzVM
  ![](2024-08-08-10-17-56.png)
* Get-AzSubscription
  ![](2024-08-08-10-18-08.png)
* execute check on CPU metrics for VM
  ![](2024-08-08-10-19-54.png)
* get the VM you are associating, resize VM in Availability Set
  ![](2024-08-08-10-23-34.png)

## Automating VM deployemtns

### why automate VM deployments

* patch/update OS
* pre-install software
* preconf settings

### how automate VM deployments
* ARM templates:
  * IaC: JSON defs of azure resources and resource configs.
  * Deployment consistency: manage resource deployments using software deployment methods
  * automation: automate resource deployments and provide modular approach to resource deployments
* VHD Template (golden image):
  * prep VM: configure VM with required software, updates and conf
  * generalize the VM: prep VM for imaging using sysprep (windows) or VM agent deprovision (linux)

### Demo: deploy VM using ARM template
* deploy a linux VM then modify the NSG rule properties
* ARM> Templates> add> create/add a template
* deploy the template, populating the parameters
  ![](2024-08-08-10-29-34.png)
  * NOTE: you can export a VM's ARM template
    ![](2024-08-08-10-33-15.png)
* deprovision the linux VM within VM OS
  ![](2024-08-08-10-33-54.png)
* in Azure deprovision the VM
  ![](2024-08-08-10-35-29.png)
* generate an image
  ![](2024-08-08-10-37-21.png)
* deploy VM from custom image
  ![](2024-08-08-10-36-52.png)
* you can provide a cloud-init to adjust settings on the VM

### summary VM deployments
* ARM template: deploy VM squickly and manage infrastructure using change control using IaC
* VHD template: create a golden image of VMs to easily deploy VMs with consistent software and configs
* Automation mgmt: manage VM deployments using custom data and manage VMs using extension scripts

## LAB: Install NGINX on a Linux VM in Deployment with Cloud Init
* create a VM
* provide cloud-init in Advanced options during create
```
#cloud-config
packages_upgrade: true
packages:
  - nginx
```
  ![](2024-08-08-10-42-11.png)

## LAB: Snapshot an Azure VM Disk using PowerShell

```
$rg = "432-ca5108e3-snapshot-an-azure-vm-disk-using-power"
$diskname = "winVM_OsDisk_1_03ef8522030741ae9fd09261849dc761"
$sasExpiryDuration = "3600"
$storageAccountName = "storkmh2disaaxyvw"
$storageAccountKey = "???"

$storageContainerName = "container1"
$destinationVHDFileName = "disk1.vhd"
$useAzCopy = 1
$vmName = "winVM"
Stop-AzVM -ResourceGroupName $rg -Name $vmName
$sas = Grant-AzDiskAccess -ResourceGroupName $rg -DiskName $diskName -DurationInSecond $sasExpiryDuration -Access Read
$destinationContext = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey

Start-AzStorageBlobCopy -AbsoluteUri $sas.AccessSAS -DestContainer $storageContainerName -DestContext $destinationContext -DestBlob $destinationVHDFileName
```

## LAB: Using Custom Images for a Virtual Machine Scale Set in Azure
* unavailable :(
  
## Managing Virtual Machine Updates

### Describing update management
* manages system updates and patches for workloads both in the azure cloud and on prem
* supports linux and windows VMs
* provides capabilities for:
  * scheduling
  * compliance scanning
  * reporting

### components of update management
* OS isntances
* Log Analytics Agent installed on OS instance
* Automation accouint (azure functions)
  * Hybrid runbook worker

#### What happens:
* pre-update report sent by log analytics agent
* human configures updates in the automation
* the hybrid runbook worker executes the start update function on the OS instance
* update report in additiona


### demo: config update management
* navigate to VM
  ![](2024-08-08-12-16-23.png)
* create/configure accounts
  ![](2024-08-08-12-17-19.png)
  * note the use of Log Analytics worker
* review logs:
  ![](2024-08-08-12-17-51.png)
* configure update deployment:
  ![](2024-08-08-12-18-24.png)

### summary
* Automation Account: service for managign update configs for VMs
* Hybrid Runbook Worker: runbook for updates and configs that will be run
* Log Analytics workspace: storage for logging details about update mgmt process
* Log Analytics Agent: agent installed on OS instance for sending back data to workspace

## Automating VM configs

### describing config automation
* automates config mgmt of VMs using Automation Account and Powershell DSC
* supports Linux and Windows VMs
* built in pull server
* powershell DSC uses declarative syntax
 
### describing Powershell DSC
![](2024-08-08-13-31-50.png)

#### how it works
* automation account: which enforces the DSC
* VM: sends state to Automation Account
* automation account: responds with the DSC

### Use case
* can unify config of multiple VMs

### demo: configure DSC
* login to ARM
* create a VM
  * polls server over HTTP, so add this
* Create an Automation Accounts
  ![](2024-08-08-13-33-37.png)
* review automation account DSC config
  ![](2024-08-08-13-34-12.png)
* import DSC config to automation account
  ![](2024-08-08-13-35-12.png)
* access the DSC config and then Compile it
* create a VM registration
  ![](2024-08-08-13-37-34.png)

### summary
* Automation acocunt: service for managing update configs for VMs
* Powershell DSC: powershell scripts that declare desired state of VMs
* Local Configuration Manager: sends current config state to pull server for eval

## Using Azure Bastion

### what is azure bastion
* jumpbox for RDP and SSH connectivity
* fully managed PaaS
* no public IPs exposed
* facts:
  * RDP/SSH connectivity is encrypted
  * Deployed per virtual network
  * Connectivity to all VMs in VNet
  * HTML5 browser supports
  * No public IP (just the Bastion has a public IP, not the VMs)
  * Only supports Ipv4
  * security is managed for the Bastion VM service 

### azure bastion architecture
* Create an `AzureBastionSubnet`, then create a Bastion, then can access the DefaultSubnet VMs

### demo: implementing azure bastion
* login to ARM
* create a VM
* in the VNet where the VM sits, create another subnet called `AzureBastionSubnet` (anything larger than /27)
* create a resource: bastions
  ![](2024-08-08-13-43-33.png)

### summary
* bastion is used to access VMs
* private traffic: traffic from Bastion to target VM stays within VNets (peer Vnets included)
* Hardened bastion: NSGs are not needed because bastion is hardened internally
* Service Integration: bastion natively integraze with Azure Firewall
* Concurrent connections: max 25 RDP and 50 SSH simultaenously
* Audit logs: enable diagnostics for auditing Bastion connections
* Required roles: `Reader` role perms are required on the Bastion, VM, and NIC in order to use Bastion

## LAB: Access Windows VMs over SSL without Public IPs Using Azure Bastion

* Create an Azure Bastion Subnet
  ![](2024-08-08-13-48-16.png)

* Create an Azure Bastion Service
  ![](2024-08-08-13-50-32.png)
  ![](2024-08-08-13-50-49.png)

* Connect to the Windows VM via Bastion
  * yarp

# network traffic mgmt

## Introducing Azure Load Balancer

### describing Azure LB
* LB is a networking solution to distribute traffic between backend compute.

### traditional vs. Azure LB
![](2024-08-08-14-14-22.png)

### Components of an Azure LB
* in VNet, there's an Azure LB
* frontend IP: private or public endpoint for accessing the load balancing solution
* Backend pool: compute solution underlying the load balancer
* health probe: probe that periodically checks the health of the backend pool to determine available nodes
* rules: loab blancing or NAT rules configed for allowing inbound/outbound access

### demo: creating an LB
* login to ARM
* vNet two subnets: default and private, 2 VMs, each with a NIC, no public IPs
* resource search bar> load balancer
  ![](2024-08-08-14-17-51.png)
  * always select "Standard", basic is for testing only
    * standard supports availability sets or VMs (combining)
  * regional or global (cross region)
  * create a new public IP
* Go to newly created LB resource and verify frontend IP config
  ![](2024-08-08-14-19-10.png)
* configure Backend pool> add
  ![](2024-08-08-14-20-12.png)
* configure the health probe
  ![](2024-08-08-14-21-10.png)
* configure load blaancign rules
  ![](2024-08-08-14-21-59.png)
  * set session persistence
* Inboudn NAT rules (ex: for inbound SSH) and Outbound rules

### summary
* load balancing: balance traffic between external or internal solutions
* health probing: health check ports for nodes in backend pool
* DNAT: port forward inbound traffic to nodes in the backend pool
* SNET: port forward outbound traffic from nodes in the backend pool
* Availability zones: determine AZ selection for deployment

## LAB: Create a Standard Load Balancer with Azure CLI

* create VMs for backend pool
```
# create NICs
az network nic create \
--resource-group $RG \
--location $LOC \
--name myNicVM1 \
--vnet-name $VNET \
--subnet $SNET \
--network-security-group $NSG

az network nic create \
--resource-group $RG \
--location $LOC \
--name myNicVM2 \
--vnet-name $VNET \
--subnet $SNET \
--network-security-group $NSG

# create VMs
az vm create \
--resource-group $RG \
--location $LOC \
--name myVM1 \
--nics myNicVM1 \
--image debian11 \
--generate-ssh-keys \
--custom-data cloud-init.txt \
--zone 1 \
--no-wait

az vm create \
--resource-group $RG \
--location $LOC \
--name myVM2 \
--nics myNicVM2 \
--image debian11 \
--generate-ssh-keys \
--custom-data cloud-init.txt \
--zone 2 \
--no-wait
```
* create LB
```
#create Public IP for LB
az network public-ip create \
--resource-group $RG \
--location $LOC \
--name myPublicIP \
--sku Standard

#create LB
az network lb create \
--resource-group $RG \
--location $LOC \
--name myLoadBalancer \
--sku Standard \
--public-ip-address myPublicIP \
--frontend-ip-name myFrontEnd \
--backend-pool-name myBackEndPool

#create LB health probe
az network lb probe create \
--resource-group $RG \
--lb-name myLoadBalancer \
--name myHealthProbe \
--protocol tcp \
--port 80

#create LB rule
az network lb rule create \
--resource-group $RG \
--lb-name myLoadBalancer \
--name myHTTPRule \
--protocol tcp \
--frontend-port 80 \
--backend-port 80 \
--frontend-ip-name myFrontEnd \
--backend-pool-name myBackEndPool \
--probe-name myHealthProbe \
--disable-outbound-snat true

#create address pool for backend
az network nic ip-config address-pool add \
--address-pool myBackEndPool \
--ip-config-name ipconfig1 \
--nic-name myNicVM1 \
--resource-group $RG \
--lb-name myLoadBalancer

#add the VM nic to the backend pool
az network nic ip-config address-pool add \
--address-pool myBackEndPool \
--ip-config-name ipconfig1 \
--nic-name myNicVM2 \
--resource-group $RG \
--lb-name myLoadBalancer

#add the VM nic to the backend pool
az network nic ip-config address-pool add \
--address-pool myBackEndPool \
--ip-config-name ipconfig1 \
--nic-name $NIC \
--resource-group $RG \
--lb-name myLoadBalancer

#check public IP
az network public-ip show \
--resource-group $RG \
--name myPublicIP \
--query [ipAddress] \
--output tsv
```

## Using Application Gateway

### describing azure application gateway
* Solution for layer 7 load balancing (HTTP/HTTPS)
* URL path-based routing
* backend resources must be redundant
* VMs, VM scale sets, and app services

### azure LB vs. app gateway
* App GW: provides URL path based routing and/or App Services

### components of an app gateway
* Frontend IP: private or public endpoint for accessing the load balancing solution.
* Backend pool: compute solution underlying the load balancer
* Listener: port, protocol, and certificate configs
* Rules: load balancing rules, HTTP settings and health probes

### demo: creating an app gateway
* login to ARM
* VNet has two subnets: default, private... one VM on each subnet
* resource search bar: application gateway> create
  ![](2024-08-08-14-34-40.png)
  * WAF is more expensive
  * enable autoscaling?
  * can do zonal deployment
  * create a new subnet that only will create the application gateway
    * `AppGatewaySubnet` with a /27
  * frontends: public or private or both (can't do just private with Standard_v2)
  * backend pool:
    ![](2024-08-08-14-37-26.png)
  * routing rule 
    ![](2024-08-08-14-38-09.png)
    * can terminate TLS at the LB
    * multi-web site supported
  * Add HTTP settings
    ![](2024-08-08-14-39-07.png)
  * add a path
    ![](2024-08-08-14-39-52.png)

### summary
* load balancing: balance traffic between backend pools using HTTP/HTTPS
* SSL termination: terminate TLS/SSL at the app gateway
* url routing: url path-based routing between multiple backend pools (multiple web sites running on a single public IP)
* security: WAF security for the LB solution
* autoscaling: scale up/down the backend pools for the app gateway

# web apps and containers

## creating an app service plan
